<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style>
.AlignLeft { text-align: left; }
.AlignCenter { text-align: center; }
.AlignRight { text-align: right; }
.Wrap { white-space: nowrap; }
body { font-family: sans-serif; font-size: 11pt; }
img.AutoScale { max-width: 100%; max-height: 100%; }
td { vertical-align: top; padding-left: 4px; padding-right: 4px; }

tr.SectionGap td { font-size: 4px; border-left: none; border-top: none; border-bottom: 1px solid Black; border-right: 1px solid Black; }
tr.SectionAll td { border-left: none; border-top: none; border-bottom: 1px solid Black; border-right: 1px solid Black; }
tr.SectionBegin td { border-left: none; border-top: none; border-right: 1px solid Black; }
tr.SectionEnd td { border-left: none; border-top: none; border-bottom: 1px solid Black; border-right: 1px solid Black; }
tr.SectionMiddle td { border-left: none; border-top: none; border-right: 1px solid Black; }
tr.SubsectionAll td { border-left: none; border-top: none; border-bottom: 1px solid Gray; border-right: 1px solid Black; }
tr.SubsectionEnd td { border-left: none; border-top: none; border-bottom: 1px solid Gray; border-right: 1px solid Black; }
table.fc { border-top: 1px solid Black; border-left: 1px solid Black; width: 100%; font-family: monospace; font-size: 10pt; }
td.TextItemInsigMod { color: #000000; background-color: #EEEEFF; }
td.TextItemInsigOrphan { color: #000000; background-color: #FAEEFF; }
td.TextItemNum { color: #696969; background-color: #ECECEC; }
td.TextItemSame { color: #000000; background-color: #FFFFFF; }
td.TextItemSigMod { color: #000000; background-color: #FFE3E3; }
td.TextItemSigOrphan { color: #000000; background-color: #F1E3FF; }
.TextSegInsigDiff { color: #0000FF; }
.TextSegReplacedDiff { color: #0000FF; font-style: italic; }
.TextSegSigDiff { color: #FF0000; }
td.TextItemInsigAdd { color: #000000; background-color: #EEEEFF; }
td.TextItemInsigDel { color: #000000; background-color: #EEEEFF; text-decoration: line-through; }
td.TextItemSigAdd { color: #000000; background-color: #FFE3E3; }
td.TextItemSigDel { color: #000000; background-color: #FFE3E3; text-decoration: line-through; }
.TextSegElementKeyword { font-weight: bold; }
.TextSegElementIdentifier { }
.TextSegElementString { color: #3A7726; }
.TextSegElementComment { color: #786A41; }
.TextSegElementOperator { }
.TextSegElementIndentation { }
</style>
<title>File Comparison</title>
</head>
<body>
File Comparison<br>
Produced: 9/27/20 8:00:14 PM<br>
&nbsp; &nbsp;
<br>
Mode:&nbsp; All, With Context, Ignoring Unimportant &nbsp;
<br>
Left file: /Users/msmolyak/Projects/Cora/Megatron-LM/mpu/random.py &nbsp;
<br>
Right file: /Users/msmolyak/Projects/Cora/DeepSpeedExamples/Megatron-LM/mpu/random.py &nbsp;
<br>
<table class="fc" cellspacing="0" cellpadding="0">
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">1</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># coding=utf-8</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">1</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># coding=utf-8</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">2</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#Modified by Samyam Rajbhandari</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">3</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#Used to partition the activations stored for backward propagation</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">4</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#Therefore reduces the memory consumption</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">5</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">2</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Copyright (c) 2019, NVIDIA CORPORATION.&nbsp; All rights reserved.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">6</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Copyright (c) 2019, NVIDIA CORPORATION.&nbsp; All rights reserved.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">3</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">7</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">4</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">8</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">5</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># you may not use this file except in compliance with the License.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">9</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># you may not use this file except in compliance with the License.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">6</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># You may obtain a copy of the License at</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">10</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># You may obtain a copy of the License at</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">7</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">11</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">8</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#&nbsp; &nbsp;&nbsp; http://www.apache.org/licenses/LICENSE-2.0</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">12</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#&nbsp; &nbsp;&nbsp; http://www.apache.org/licenses/LICENSE-2.0</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">9</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">13</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">10</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Unless required by applicable law or agreed to in writing, software</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">14</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Unless required by applicable law or agreed to in writing, software</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">11</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">15</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">12</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">16</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">13</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># See the License for the specific language governing permissions and</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">17</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># See the License for the specific language governing permissions and</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">14</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># limitations under the License.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">18</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># limitations under the License.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">15</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">19</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">16</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">20</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">17</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Parts of the code here are adapted from PyTorch</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">21</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Parts of the code here are adapted from PyTorch</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">18</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># repo: https://github.com/pytorch/pytorch</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">22</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># repo: https://github.com/pytorch/pytorch</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">19</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">20</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">contextlib</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">23</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">contextlib</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">21</td>
<td class="TextItemSigMod Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">24</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">import</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span> <span class="TextSegSigDiff">as</span> <span class="TextSegSigDiff">dist</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">22</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">torch</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">25</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">torch</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">23</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">torch</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">_C</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">26</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">torch</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">_C</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">24</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">_lazy_call</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">device</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">device_ctx_manager</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">27</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">_lazy_call</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">device</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">device_ctx_manager</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">25</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">from</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">utils</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpoint</span> <span class="TextSegSigDiff">import</span> <span class="TextSegSigDiff">detach_variable</span></td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">28</td>
<td class="TextItemSigMod Wrap">#from torch.utils.checkpoint import detach_variable</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">26</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">29</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">30</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">31</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">import</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span> <span class="TextSegSigDiff">as</span> <span class="TextSegSigDiff">dist</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">32</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">PARTITION_ACTIVATIONS</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">False</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">33</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">PA_CORRECTNESS_TEST</span><span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">False</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">34</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">35</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">see_memory_usage</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">message</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">force</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">False</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">36</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">not</span> <span class="TextSegSigDiff">force</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">37</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">38</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">dist</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">barrier</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">39</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">dist</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_rank</span><span class="TextSegSigDiff">()</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">40</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">message</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">41</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;Memory Allocated &quot;</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">memory_allocated</span><span class="TextSegSigDiff">()/(</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">*</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">*</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">&quot;GigaBytes&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">42</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;Max Memory Allocated &quot;</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">max_memory_allocated</span><span class="TextSegSigDiff">()/(</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">*</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">*</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">&quot;GigaBytes&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">43</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;Cache Allocated &quot;</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">memory_cached</span><span class="TextSegSigDiff">()/(</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">*</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">*</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">&quot;GigaBytes&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">44</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;Max cache Allocated &quot;</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">max_memory_cached</span><span class="TextSegSigDiff">()/(</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">*</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">*</span><span class="TextSegSigDiff">1024</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">&quot;GigaBytes&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">45</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot; &quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">46</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; #input(&quot;Press Any Key To Continue ..&quot;)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">47</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">48</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">27</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">initialize</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_data_parallel_rank</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">49</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">initialize</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_data_parallel_rank</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">28</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">initialize</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_model_parallel_rank</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">50</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">initialize</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_model_parallel_rank</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">51</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">from</span> <span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">initialize</span> <span class="TextSegSigDiff">import</span> <span class="TextSegSigDiff">get_model_parallel_world_size</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">52</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">from</span> <span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">initialize</span> <span class="TextSegSigDiff">import</span> <span class="TextSegSigDiff">get_model_parallel_group</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">29</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">53</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">54</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">mp_rank</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">None</span> #get_model_parallel_rank()</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">55</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">mp_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">None</span> #get_model_parallel_world_size()</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">56</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">mp_group</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">None</span> #get_model_parallel_group()</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">30</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">57</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">31</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Default name for the model parallel rng tracker.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">58</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Default name for the model parallel rng tracker.</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">32</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIdentifier">_MODEL_PARALLEL_RNG_TRACKER_NAME</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementString">'model-parallel-rng'</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">59</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIdentifier">_MODEL_PARALLEL_RNG_TRACKER_NAME</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementString">'model-parallel-rng'</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">60</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">transport_stream</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">None</span>&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">61</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">cuda_device</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">None</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">62</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">detach_variable</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">None</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">63</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">isinstance</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tuple</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">64</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">out</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">[]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">65</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">inp</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">66</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">not</span> <span class="TextSegSigDiff">isinstance</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">inp</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">Tensor</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">67</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">out</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">append</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">inp</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">68</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">continue</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">33</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">69</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">70</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">requires_grad</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">inp</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">requires_grad</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">71</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">72</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">device</span> <span class="TextSegSigDiff">is</span> <span class="TextSegSigDiff">not</span> <span class="TextSegSigDiff">None</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">73</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">x</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">inp</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">to</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">74</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">75</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">x</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">inp</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">76</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">77</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">x</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">x</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">detach</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">78</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">x</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">requires_grad</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">requires_grad</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">79</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">out</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">append</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">x</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">80</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span> <span class="TextSegSigDiff">tuple</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">out</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">81</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">82</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">raise</span> <span class="TextSegSigDiff">RuntimeError</span><span class="TextSegSigDiff">(</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">83</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">&quot;Only tuple of tensors is supported. Got Unsupported input type: &quot;</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">type</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">__name__</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">34</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">84</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">35</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">new_state</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">=-</span>1<span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">85</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">new_state</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">=-</span>1<span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">36</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Sets the random number generator state of the current GPU.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">86</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Sets the random number generator state of the current GPU.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">37</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">87</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">38</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Argumentss:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">88</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Argumentss:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">39</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; new_state (torch.ByteTensor): The desired state</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">89</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; new_state (torch.ByteTensor): The desired state</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">40</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; This function is adapted from PyTorch repo (torch.cuda.set_rng_state)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">90</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; This function is adapted from PyTorch repo (torch.cuda.set_rng_state)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">41</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; with a single change: the input state is not cloned. Cloning caused</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">91</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; with a single change: the input state is not cloned. Cloning caused</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">42</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; major performance issues for +4 GPU cases.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">92</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; major performance issues for +4 GPU cases.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">43</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">93</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">44</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">hasattr</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">_C</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementString">'_cuda_setRNGState'</span><span class="TextSegElementOperator">)</span> <span class="TextSegElementKeyword">and</span> <span class="TextSegElementIdentifier">callable</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">_C</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_cuda_setRNGState</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">94</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">hasattr</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">_C</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementString">'_cuda_setRNGState'</span><span class="TextSegElementOperator">)</span> <span class="TextSegElementKeyword">and</span> <span class="TextSegElementIdentifier">callable</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">_C</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_cuda_setRNGState</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">45</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # older PyTorch</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">95</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # older PyTorch</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">46</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">cb</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">96</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">cb</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">47</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">device_ctx_manager</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">97</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">device_ctx_manager</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">48</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_C</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_cuda_setRNGState</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">new_state</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">98</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_C</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_cuda_setRNGState</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">new_state</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">49</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">else</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">99</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">else</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">50</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # newer PyTorch</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">100</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # newer PyTorch</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">51</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">device</span> <span class="TextSegElementOperator">==</span> <span class="TextSegElementOperator">-</span>1:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">101</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">device</span> <span class="TextSegElementOperator">==</span> <span class="TextSegElementOperator">-</span>1:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">52</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">device</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'cuda'</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">102</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">device</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'cuda'</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">53</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">elif</span> <span class="TextSegElementIdentifier">isinstance</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">str</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">103</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">elif</span> <span class="TextSegElementIdentifier">isinstance</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">str</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">54</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">device</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">104</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">device</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">55</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">elif</span> <span class="TextSegElementIdentifier">isinstance</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">int</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">105</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">elif</span> <span class="TextSegElementIdentifier">isinstance</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">int</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">56</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">device</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'cuda'</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">106</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">device</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'cuda'</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">57</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">107</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">58</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">cb</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">108</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">cb</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">59</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">idx</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">index</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">109</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">idx</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">index</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">60</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">idx</span> <span class="TextSegElementKeyword">is</span> <span class="TextSegElementKeyword">None</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">110</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">idx</span> <span class="TextSegElementKeyword">is</span> <span class="TextSegElementKeyword">None</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">61</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">idx</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">current_device</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">111</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">idx</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">current_device</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">62</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">default_generator</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">default_generators</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">idx</span><span class="TextSegElementOperator">]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">112</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">default_generator</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">default_generators</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">idx</span><span class="TextSegElementOperator">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">63</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">default_generator</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">set_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">new_state</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">113</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">default_generator</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">set_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">new_state</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">64</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">114</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">65</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_lazy_call</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">cb</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">115</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_lazy_call</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">cb</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">116</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">66</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">117</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">67</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">118</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">68</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">CudaRNGStatesTracker</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">119</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">CudaRNGStatesTracker</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">69</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Tracker for the cuda RNG states.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">120</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Tracker for the cuda RNG states.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">70</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">121</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">71</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Using the `add` method, a cuda rng state is initialized based on</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">122</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Using the `add` method, a cuda rng state is initialized based on</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">72</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; the input `seed` and is assigned to `name`. Later, by forking the</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">123</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; the input `seed` and is assigned to `name`. Later, by forking the</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">73</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; rng state, we can perform operations and return to our starting</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">124</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; rng state, we can perform operations and return to our starting</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">74</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; cuda state.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">125</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; cuda state.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">75</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">126</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">76</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">127</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">77</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Map from a string name to the cuda rng state.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">128</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Map from a string name to the cuda rng state.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">78</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementOperator">{}</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">129</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementOperator">{}</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">79</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Seeds are just for book keeping and ensure no seed is set twice.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">130</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Seeds are just for book keeping and ensure no seed is set twice.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">80</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seeds_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">set</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">131</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seeds_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">set</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">81</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">132</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">82</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">reset</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">133</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">reset</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">83</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Set to the initial state (no tracker).&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">134</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Set to the initial state (no tracker).&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">84</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementOperator">{}</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">135</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementOperator">{}</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">85</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seeds_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">set</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">136</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seeds_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">set</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">86</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">137</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">87</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">get_states</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">138</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">get_states</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">88</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Get rng states. Copy the dictionary so we have direct</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">139</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Get rng states. Copy the dictionary so we have direct</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">89</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; pointers to the states, not just a pointer to the dictionary.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">140</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; pointers to the states, not just a pointer to the dictionary.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">90</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementOperator">{}</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">141</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementOperator">{}</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">91</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">name</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">142</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">name</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">92</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">states</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">143</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">states</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">93</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">states</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">144</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">states</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">94</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">145</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">95</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">set_states</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">states</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">146</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">set_states</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">states</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">96</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Set the rng states. For efficiency purposes, we do not check</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">147</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Set the rng states. For efficiency purposes, we do not check</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">97</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; the size of seed for compatibility.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">148</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; the size of seed for compatibility.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">98</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">states</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">149</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">states</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">99</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">150</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">100</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">add</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">151</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">add</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">101</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Track the rng state.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">152</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Track the rng state.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">102</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Check seed is not already used.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">153</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Check seed is not already used.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">103</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">seed</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seeds_</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">154</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">seed</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seeds_</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">104</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">raise</span> <span class="TextSegElementIdentifier">Exception</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'seed {} already exists'</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">format</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">))</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">155</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">raise</span> <span class="TextSegElementIdentifier">Exception</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'seed {} already exists'</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">format</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">))</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">105</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seeds_</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">add</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">156</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seeds_</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">add</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">106</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Check that state is not already defined.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">157</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Check that state is not already defined.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">107</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">name</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">158</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">name</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">108</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">raise</span> <span class="TextSegElementIdentifier">Exception</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'cuda rng state {} already exists'</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">format</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">))</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">159</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">raise</span> <span class="TextSegElementIdentifier">Exception</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'cuda rng state {} already exists'</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">format</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">))</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">109</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Get the current rng state.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">160</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Get the current rng state.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">110</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">orig_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">161</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">orig_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">111</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set the new state and store it.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">162</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set the new state and store it.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">112</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">manual_seed</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">163</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">manual_seed</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">113</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">164</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">114</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Reset rng state to what it was.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">165</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Reset rng state to what it was.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">115</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">orig_rng_state</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">166</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">orig_rng_state</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">116</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">167</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">117</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementOperator">@</span><span class="TextSegElementIdentifier">contextlib</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">contextmanager</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">168</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementOperator">@</span><span class="TextSegElementIdentifier">contextlib</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">contextmanager</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">118</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">fork</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">_MODEL_PARALLEL_RNG_TRACKER_NAME</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">169</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">fork</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">_MODEL_PARALLEL_RNG_TRACKER_NAME</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">119</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Fork the cuda rng state, perform operations, and exit with</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">170</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Fork the cuda rng state, perform operations, and exit with</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">120</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; the original state.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">171</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; the original state.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">121</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Check if we have added the state</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">172</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Check if we have added the state</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">122</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">name</span> <span class="TextSegElementKeyword">not</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">173</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">name</span> <span class="TextSegElementKeyword">not</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">123</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">raise</span> <span class="TextSegElementIdentifier">Exception</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'cuda rng state {} is not added'</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">format</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">))</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">174</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">raise</span> <span class="TextSegElementIdentifier">Exception</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'cuda rng state {} is not added'</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">format</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">))</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">124</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Store current rng state.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">175</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Store current rng state.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">125</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">orig_cuda_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">176</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">orig_cuda_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">126</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set rng state to the desired one</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">177</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set rng state to the desired one</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">127</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">])</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">178</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">])</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">128</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Do the stuff we wanted to do.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">179</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Do the stuff we wanted to do.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">129</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">try</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">180</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">try</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">130</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">yield</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">181</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">yield</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">131</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">finally</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">182</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">finally</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">132</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # Update the current rng state for later use.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">183</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # Update the current rng state for later use.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">133</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">184</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">states_</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">name</span><span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">134</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # And set the state to the original state we started with.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">185</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # And set the state to the original state we started with.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">135</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">orig_cuda_rng_state</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">186</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">orig_cuda_rng_state</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">136</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">187</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">137</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">188</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">138</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># RNG tracker object.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">189</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># RNG tracker object.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">139</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIdentifier">_CUDA_RNG_STATE_TRACKER</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">CudaRNGStatesTracker</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">190</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIdentifier">_CUDA_RNG_STATE_TRACKER</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">CudaRNGStatesTracker</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">140</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">191</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">141</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">192</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">142</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">193</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">143</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Get cuda rng tracker.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">194</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Get cuda rng tracker.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">144</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">_CUDA_RNG_STATE_TRACKER</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">195</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">_CUDA_RNG_STATE_TRACKER</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">145</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">196</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">146</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">197</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">147</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">model_parallel_cuda_manual_seed</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">198</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">model_parallel_cuda_manual_seed</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">148</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Initialize model parallel cuda seed.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">199</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Initialize model parallel cuda seed.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">149</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">200</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">150</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; This function should be called after the model parallel is</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">201</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; This function should be called after the model parallel is</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">151</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; initialized. Also, no torch.cuda.manual_seed should be called</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">202</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; initialized. Also, no torch.cuda.manual_seed should be called</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">152</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; after this function. Basically, this is replacement for that</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">203</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; after this function. Basically, this is replacement for that</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">153</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; function.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">204</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; function.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">154</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Two set of RNG states are tracked:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">205</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Two set of RNG states are tracked:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">155</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; default state: This is for data parallelism and is the same among a</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">206</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; default state: This is for data parallelism and is the same among a</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">156</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set of model parallel GPUs but different across</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">207</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set of model parallel GPUs but different across</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">157</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; different model paralle groups. This is used for</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">208</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; different model paralle groups. This is used for</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">158</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; example for dropout in the non-model-parallel regions.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">209</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; example for dropout in the non-model-parallel regions.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">159</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; model-parallel state: This state is different among a set of model</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">210</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; model-parallel state: This state is different among a set of model</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">160</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; parallel GPUs, but the same across data parallel</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">211</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; parallel GPUs, but the same across data parallel</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">161</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; groups. This is used for example for dropout in</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">212</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; groups. This is used for example for dropout in</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">162</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; model parallel regions.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">213</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; model parallel regions.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">163</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">214</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">164</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # 2718 is just for fun and any POSITIVE value will work.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">215</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # 2718 is just for fun and any POSITIVE value will work.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">165</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">offset</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">seed</span> <span class="TextSegElementOperator">+</span> 2718</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">216</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">offset</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">seed</span> <span class="TextSegElementOperator">+</span> 2718</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">166</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model_parallel_seed</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">offset</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">get_model_parallel_rank</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">217</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model_parallel_seed</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">offset</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">get_model_parallel_rank</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">167</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Data parallel gets the original sedd.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">218</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Data parallel gets the original sedd.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">168</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">data_parallel_seed</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">seed</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">219</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">data_parallel_seed</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">seed</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">169</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">220</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">170</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">distributed</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rank</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementOperator">==</span> 0:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">221</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">distributed</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rank</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementOperator">==</span> 0:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">171</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'&gt; initializing model parallel cuda seeds on global rank {}, '</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">222</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'&gt; initializing model parallel cuda seeds on global rank {}, '</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">172</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'model parallel rank {}, and data parallel rank {} with '</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">223</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'model parallel rank {}, and data parallel rank {} with '</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">173</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'model parallel seed: {} and data parallel seed: {}'</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">format</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">224</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'model parallel seed: {} and data parallel seed: {}'</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">format</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">174</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">distributed</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rank</span><span class="TextSegElementOperator">(),</span> <span class="TextSegElementIdentifier">get_model_parallel_rank</span><span class="TextSegElementOperator">(),</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">225</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">distributed</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rank</span><span class="TextSegElementOperator">(),</span> <span class="TextSegElementIdentifier">get_model_parallel_rank</span><span class="TextSegElementOperator">(),</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">175</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">get_data_parallel_rank</span><span class="TextSegElementOperator">(),</span> <span class="TextSegElementIdentifier">model_parallel_seed</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">226</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">get_data_parallel_rank</span><span class="TextSegElementOperator">(),</span> <span class="TextSegElementIdentifier">model_parallel_seed</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">176</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">data_parallel_seed</span><span class="TextSegElementOperator">),</span> <span class="TextSegElementIdentifier">flush</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">227</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">data_parallel_seed</span><span class="TextSegElementOperator">),</span> <span class="TextSegElementIdentifier">flush</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">177</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_CUDA_RNG_STATE_TRACKER</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">reset</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">228</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_CUDA_RNG_STATE_TRACKER</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">reset</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">178</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Set the default state.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">229</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Set the default state.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">179</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">manual_seed</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">data_parallel_seed</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">230</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">manual_seed</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">data_parallel_seed</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">180</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # and model parallel state.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">231</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # and model parallel state.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">181</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_CUDA_RNG_STATE_TRACKER</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">add</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">_MODEL_PARALLEL_RNG_TRACKER_NAME</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">232</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_CUDA_RNG_STATE_TRACKER</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">add</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">_MODEL_PARALLEL_RNG_TRACKER_NAME</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">182</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model_parallel_seed</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">233</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model_parallel_seed</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">183</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">234</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">184</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">235</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">236</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">get_partition_start</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">237</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">global</span> <span class="TextSegSigDiff">mp_rank</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mp_size</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mp_group</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">238</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">partition_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">get_partition_size</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">239</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">start</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">partition_size</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">mp_rank</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">240</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span> <span class="TextSegSigDiff">int</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">start</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">241</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">242</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">get_partition_size</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">243</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">global</span> <span class="TextSegSigDiff">mp_rank</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mp_size</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mp_group</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">244</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">numel</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">245</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">partition_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">/</span><span class="TextSegSigDiff">mp_size</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">246</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span> <span class="TextSegSigDiff">int</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">partition_size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">247</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">248</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">get_full_inputs</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">tensors</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">249</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">=[]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">250</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">i</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">range</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">int</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">len</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">tensors</span><span class="TextSegSigDiff">)/</span><span class="TextSegSigDiff">2</span><span class="TextSegSigDiff">)-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">251</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">item</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tensors</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">2</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">i</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">252</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tensors</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">2</span><span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">i</span> <span class="TextSegSigDiff">+</span> <span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">253</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">partition_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">numel</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">254</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tensor_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">partition_size</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">mp_size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">255</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">flat_tensor</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">zeros</span><span class="TextSegSigDiff">([</span><span class="TextSegSigDiff">tensor_size</span><span class="TextSegSigDiff">],</span> <span class="TextSegSigDiff">dtype</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">dtype</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">256</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">partitions</span><span class="TextSegSigDiff">=[]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">257</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">i</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">range</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">mp_size</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">258</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">part_i</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">flat_tensor</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">narrow</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">partition_size</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">i</span> <span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">partition_size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">259</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">i</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">mp_rank</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">260</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">part_i</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">copy_</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">261</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">partitions</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">append</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">part_i</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">262</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">dist</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">all_gather</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">partitions</span><span class="TextSegSigDiff">,</span><span class="TextSegSigDiff">partitions</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">mp_rank</span><span class="TextSegSigDiff">],</span> <span class="TextSegSigDiff">group</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">mp_group</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">263</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">input_tensor</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">flat_tensor</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">list</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">numpy</span><span class="TextSegSigDiff">()))</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">264</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">data</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">input_tensor</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">data</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">265</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">266</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">append</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">267</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">append</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">tensors</span><span class="TextSegSigDiff">[-</span><span class="TextSegSigDiff">2</span><span class="TextSegSigDiff">])</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">268</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">269</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span> <span class="TextSegSigDiff">tuple</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">270</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">271</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">272</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">185</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">CheckpointFunction</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">autograd</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Function</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">273</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">CheckpointFunction</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">autograd</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Function</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">186</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;This function is adapted from torch.utils.checkpoint with</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">274</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;This function is adapted from torch.utils.checkpoint with</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">187</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; two main changes:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">275</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; two main changes:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">188</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1) torch.cuda.set_rng_state is replaced with `_set_cuda_rng_state`</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">276</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1) torch.cuda.set_rng_state is replaced with `_set_cuda_rng_state`</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">189</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2) the states in the model parallel tracker are also properly</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">277</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2) the states in the model parallel tracker are also properly</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">190</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tracked/set/reset.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">278</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; tracked/set/reset.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">191</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">279</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">192</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementOperator">@</span><span class="TextSegElementIdentifier">staticmethod</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">280</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementOperator">@</span><span class="TextSegElementIdentifier">staticmethod</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">193</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">run_function</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">281</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">run_function</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">194</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">run_function</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">run_function</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">282</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">run_function</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">run_function</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">283</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">global</span> <span class="TextSegSigDiff">mp_rank</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mp_size</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mp_group</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">284</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">mp_rank</span> <span class="TextSegSigDiff">is</span> <span class="TextSegSigDiff">None</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">285</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">mp_rank</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">get_model_parallel_rank</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">286</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">mp_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">get_model_parallel_world_size</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">287</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">mp_group</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">get_model_parallel_group</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">195</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">288</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">289</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">290</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">global</span> <span class="TextSegSigDiff">cuda_device</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">transport_stream</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">PARTITION_ACTIVATIONS</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">291</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">cuda_device</span> <span class="TextSegSigDiff">is</span> <span class="TextSegSigDiff">None</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">292</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">dist</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_rank</span><span class="TextSegSigDiff">()</span>&nbsp; <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">293</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">f</span><span class="TextSegSigDiff">&quot;Partition Activations {PARTITION_ACTIVATIONS} and Correctness Check {PA_CORRECTNESS_TEST}&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">294</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">295</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">cuda_device</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">current_device</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">296</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #The transport stream is used to overlap the allgather communication for the activations</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">297</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #with the computation in the backward pass</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">298</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">transport_stream</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">Stream</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">cuda_device</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">299</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">300</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">PARTITION_ACTIVATIONS</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">301</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">inputs</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">detach</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">contiguous</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">narrow</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">get_partition_start</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">get_partition_size</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">)).</span><span class="TextSegSigDiff">clone</span><span class="TextSegSigDiff">()</span> <span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">item</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">]]</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">302</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">append</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">[-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">])</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">303</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">304</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; #just in case something funky is happening such as reuse of inputs</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">305</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">inputs_cuda</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">to</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">cuda_device</span><span class="TextSegSigDiff">)</span> <span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">item</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">306</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">196</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Copy the rng states.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">307</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Copy the rng states.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">197</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cpu_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">308</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cpu_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">198</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cuda_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">309</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cuda_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">199</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cuda_rng_state_tracker</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">get_states</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">310</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cuda_rng_state_tracker</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">get_states</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">200</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">311</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">201</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">ctx</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">save_for_backward</span><span class="TextSegSigDiff">(*</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span></td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">312</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; #ctx.save_for_backward(*args)</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">202</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">no_grad</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">313</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">no_grad</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">203</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; outputs = run_function(*a<span class="TextSegSigDiff">rgs</span>)</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">314</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; outputs = run_function(*<span class="TextSegSigDiff">inputs_cud</span>a)</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">315</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">316</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">del</span> <span class="TextSegSigDiff">inputs_cuda</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">317</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">318</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">PARTITION_ACTIVATIONS</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">319</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">new_args</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">[]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">320</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">arg</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">inp</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">zip</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">,</span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">321</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">tensor</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">arg</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">())</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">322</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">arg</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">data</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">inp</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">data</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">323</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">new_args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">append</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">arg</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">324</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">new_args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">append</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">325</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">ctx</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">save_for_backward</span><span class="TextSegSigDiff">(*</span><span class="TextSegSigDiff">new_args</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">326</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">327</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">ctx</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">save_for_backward</span><span class="TextSegSigDiff">(*</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">328</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">204</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">outputs</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">329</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">outputs</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">205</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">330</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">206</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementOperator">@</span><span class="TextSegElementIdentifier">staticmethod</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">331</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementOperator">@</span><span class="TextSegElementIdentifier">staticmethod</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">207</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">backward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">332</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">backward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">208</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementKeyword">not</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">autograd</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_is_checkpoint_valid</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">333</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementKeyword">not</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">autograd</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_is_checkpoint_valid</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">209</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">raise</span> <span class="TextSegElementIdentifier">RuntimeError</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;Checkpointing is not compatible with .grad(), &quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">334</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">raise</span> <span class="TextSegElementIdentifier">RuntimeError</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;Checkpointing is not compatible with .grad(), &quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">210</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementString">&quot;please use .backward() if possible&quot;</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">335</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementString">&quot;please use .backward() if possible&quot;</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">336</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">337</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">global</span> <span class="TextSegSigDiff">cuda_device</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">transport_stream</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">PARTITION_ACTIVATIONS</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">338</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">339</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">PARTITION_ACTIVATIONS</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">340</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">with</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">stream</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">transport_stream</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">341</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">inputs</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">get_full_inputs</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">ctx</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">saved_tensors</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">342</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">detached_inputs</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">detach_variable</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">343</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">211</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; inputs = ctx.saved_tensors</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">344</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;<span class="TextSegSigDiff">&nbsp; &nbsp; </span>inputs = ctx.saved_tensors</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">345</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">detached_inputs</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">detach_variable</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">inputs</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">212</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">346</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">213</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Store the current states.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">347</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Store the current states.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">214</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">bwd_cpu_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">348</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">bwd_cpu_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">215</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">bwd_cuda_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">349</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">bwd_cuda_rng_state</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_rng_state</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">216</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">bwd_cuda_rng_state_tracker</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">get_states</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">350</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">bwd_cuda_rng_state_tracker</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">get_states</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">217</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">351</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">218</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set the states to what it used to be before the forward pass.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">352</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set the states to what it used to be before the forward pass.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">219</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">set_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cpu_rng_state</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">353</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">set_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cpu_rng_state</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">220</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cuda_rng_state</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">354</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cuda_rng_state</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">221</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">set_states</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cuda_rng_state_tracker</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">355</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">set_states</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fwd_cuda_rng_state_tracker</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">222</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">356</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">223</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Compute the forward pass.</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">357</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">PARTI</span><span class="TextSegSigDiff">TI</span><span class="TextSegSigDiff">ON_ACTIVATIONS</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">224</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <span class="TextSegSigDiff">detach</span><span class="TextSegSigDiff">ed_input</span><span class="TextSegSigDiff">s</span> = <span class="TextSegSigDiff">deta</span>ch<span class="TextSegSigDiff">_v</span>a<span class="TextSegSigDiff">riabl</span>e<span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">input</span><span class="TextSegSigDiff">s</span>)</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">358</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;<span class="TextSegSigDiff">&nbsp; &nbsp; </span><span class="TextSegSigDiff">curre</span><span class="TextSegSigDiff">n</span><span class="TextSegSigDiff">t_stream</span>=<span class="TextSegSigDiff">tor</span>ch<span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cud</span>a<span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">curr</span>e<span class="TextSegSigDiff">n</span><span class="TextSegSigDiff">t_stream</span><span class="TextSegSigDiff">(</span>)</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">359</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">current_stream</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">wait_stream</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">transport_stream</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">360</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">225</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">enable_grad</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">361</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">enable_grad</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">226</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">outputs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">run_function</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">detached_inputs</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">362</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">outputs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">ctx</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">run_function</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">detached_inputs</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">227</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">363</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">228</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set the states back to what it was at the start of this function.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">364</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set the states back to what it was at the start of this function.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">229</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">set_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">bwd_cpu_rng_state</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">365</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">set_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">bwd_cpu_rng_state</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">230</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">bwd_cuda_rng_state</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">366</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_set_cuda_rng_state</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">bwd_cuda_rng_state</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">231</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">set_states</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">bwd_cuda_rng_state_tracker</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">367</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">set_states</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">bwd_cuda_rng_state_tracker</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">232</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">368</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">233</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">isinstance</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">outputs</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Tensor</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">369</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">isinstance</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">outputs</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Tensor</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">234</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">outputs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">outputs</span><span class="TextSegElementOperator">,)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">370</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">outputs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">outputs</span><span class="TextSegElementOperator">,)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">235</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">autograd</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">backward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">outputs</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">371</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">autograd</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">backward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">outputs</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">236</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementOperator">(</span><span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">,)</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">tuple</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">inp</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">grad</span> <span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">inp</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">detached_inputs</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">372</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementOperator">(</span><span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">,)</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">tuple</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">inp</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">grad</span> <span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">inp</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">detached_inputs</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">237</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">373</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">238</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">374</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">239</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">checkpoint</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">function</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">375</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">checkpoint</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">function</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">240</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Checkpoint a model or part of the model.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">376</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Checkpoint a model or part of the model.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">241</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; This has been directly copied from torch.utils.checkpoint.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">377</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; This has been directly copied from torch.utils.checkpoint.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">242</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">CheckpointFunction</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">apply</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">function</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">378</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">CheckpointFunction</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">apply</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">function</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">379</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">380</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">partition_activations_in_checkpoint</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">partition_activation</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">381</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">global</span> <span class="TextSegSigDiff">PARTITION_ACTIVATIONS</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">382</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">PARTITION_ACTIVATIONS</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">partition_activation</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">383</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">dist</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_rank</span><span class="TextSegSigDiff">()</span>&nbsp; <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">384</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">f</span><span class="TextSegSigDiff">&quot;**************Partition Activations {PARTITION_ACTIVATIONS}************&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">385</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">386</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
</table>
<br>
</body>
</html>
