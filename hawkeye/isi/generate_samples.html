<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style>
.AlignLeft { text-align: left; }
.AlignCenter { text-align: center; }
.AlignRight { text-align: right; }
.Wrap { white-space: nowrap; }
body { font-family: sans-serif; font-size: 11pt; }
img.AutoScale { max-width: 100%; max-height: 100%; }
td { vertical-align: top; padding-left: 4px; padding-right: 4px; }

tr.SectionGap td { font-size: 4px; border-left: none; border-top: none; border-bottom: 1px solid Black; border-right: 1px solid Black; }
tr.SectionAll td { border-left: none; border-top: none; border-bottom: 1px solid Black; border-right: 1px solid Black; }
tr.SectionBegin td { border-left: none; border-top: none; border-right: 1px solid Black; }
tr.SectionEnd td { border-left: none; border-top: none; border-bottom: 1px solid Black; border-right: 1px solid Black; }
tr.SectionMiddle td { border-left: none; border-top: none; border-right: 1px solid Black; }
tr.SubsectionAll td { border-left: none; border-top: none; border-bottom: 1px solid Gray; border-right: 1px solid Black; }
tr.SubsectionEnd td { border-left: none; border-top: none; border-bottom: 1px solid Gray; border-right: 1px solid Black; }
table.fc { border-top: 1px solid Black; border-left: 1px solid Black; width: 100%; font-family: monospace; font-size: 10pt; }
td.TextItemInsigMod { color: #000000; background-color: #EEEEFF; }
td.TextItemInsigOrphan { color: #000000; background-color: #FAEEFF; }
td.TextItemNum { color: #696969; background-color: #ECECEC; }
td.TextItemSame { color: #000000; background-color: #FFFFFF; }
td.TextItemSigMod { color: #000000; background-color: #FFE3E3; }
td.TextItemSigOrphan { color: #000000; background-color: #F1E3FF; }
.TextSegInsigDiff { color: #0000FF; }
.TextSegReplacedDiff { color: #0000FF; font-style: italic; }
.TextSegSigDiff { color: #FF0000; }
td.TextItemInsigAdd { color: #000000; background-color: #EEEEFF; }
td.TextItemInsigDel { color: #000000; background-color: #EEEEFF; text-decoration: line-through; }
td.TextItemSigAdd { color: #000000; background-color: #FFE3E3; }
td.TextItemSigDel { color: #000000; background-color: #FFE3E3; text-decoration: line-through; }
.TextSegElementKeyword { font-weight: bold; }
.TextSegElementIdentifier { }
.TextSegElementNumber { color: #2E9269; }
.TextSegElementString { color: #3A7726; }
.TextSegElementComment { color: #786A41; }
.TextSegElementOperator { }
.TextSegElementIndentation { }
</style>
<title>File Comparison</title>
</head>
<body>
File Comparison<br>
Produced: 10/6/20 4:02:49 PM<br>
&nbsp; &nbsp;
<br>
Mode:&nbsp; All, With Context, Ignoring Unimportant &nbsp;
<br>
Left file: /Users/msmolyak/Projects/Cora/DeepSpeedExamples/Megatron-LM/generate_samples.py &nbsp;
<br>
Right file: /Users/msmolyak/Projects/Cora/DeepSpeedExamplesISI/Megatron-LM/generate_samples.py &nbsp;
<br>
<table class="fc" cellspacing="0" cellpadding="0">
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">1</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># coding=utf-8</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">1</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># coding=utf-8</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">2</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Copyright (c) 2019, NVIDIA CORPORATION.&nbsp; All rights reserved.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">2</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Copyright (c) 2019, NVIDIA CORPORATION.&nbsp; All rights reserved.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">3</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">3</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">4</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">4</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">5</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># you may not use this file except in compliance with the License.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">5</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># you may not use this file except in compliance with the License.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">6</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># You may obtain a copy of the License at</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">6</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># You may obtain a copy of the License at</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">7</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">7</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">8</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#&nbsp; &nbsp;&nbsp; http://www.apache.org/licenses/LICENSE-2.0</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">8</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#&nbsp; &nbsp;&nbsp; http://www.apache.org/licenses/LICENSE-2.0</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">9</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">9</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">10</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Unless required by applicable law or agreed to in writing, software</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">10</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Unless required by applicable law or agreed to in writing, software</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">11</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">11</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">12</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">12</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">13</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># See the License for the specific language governing permissions and</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">13</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># See the License for the specific language governing permissions and</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">14</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># limitations under the License.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">14</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># limitations under the License.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">15</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">15</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">16</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&quot;&quot;&quot;Sample Generate GPT2&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">16</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&quot;&quot;&quot;Sample Generate GPT2&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">17</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">17</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">18</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">os</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">18</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">os</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">19</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">random</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">19</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">random</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">20</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">import</span> <span class="TextSegSigDiff">json</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">21</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">import</span> <span class="TextSegSigDiff">copy</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">20</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">numpy</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">np</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">22</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">numpy</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">np</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">21</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">torch</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">23</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">torch</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">22</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">functional</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">F</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">24</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">functional</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">F</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">23</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">argparse</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">25</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">argparse</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">24</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">time</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">26</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">time</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">25</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">arguments</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_args</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">27</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">arguments</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_args</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">26</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">Timers</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">28</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">Timers</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">27</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">pretrain_gpt2</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">initialize_distributed</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">29</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">pretrain_gpt2</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">initialize_distributed</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">28</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">pretrain_gpt2</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">set_random_seed</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">30</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">pretrain_gpt2</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">set_random_seed</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">29</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">pretrain_gpt2</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_train_val_test_data</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">31</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">pretrain_gpt2</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_train_val_test_data</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">30</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">pretrain_gpt2</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_masks_and_position_ids</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">32</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">pretrain_gpt2</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_masks_and_position_ids</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">31</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">load_checkpoint</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">33</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">load_checkpoint</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">32</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">data_utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">make_tokenizer</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">34</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">data_utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">make_tokenizer</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">33</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">configure_data</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">configure_data</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">35</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">configure_data</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">configure_data</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">34</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">mpu</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">36</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">mpu</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">37</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">from</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">utils</span> <span class="TextSegSigDiff">import</span> <span class="TextSegSigDiff">VocabUtility</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">35</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">38</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">36</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">fp16</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">FP16_Module</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">39</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">fp16</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">FP16_Module</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">37</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">model</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">GPT2Model</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">40</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">model</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">GPT2Model</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">38</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">model</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">DistributedDataParallel</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">DDP</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">41</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">model</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">DistributedDataParallel</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">DDP</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">39</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">print_rank_0</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">42</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">print_rank_0</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">40</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">43</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">41</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">get_model</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">44</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">get_model</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">42</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Build the model.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">45</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Build the model.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">43</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">46</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">44</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">print_rank_0</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'building GPT2 model ...'</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">47</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">print_rank_0</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'building GPT2 model ...'</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">45</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">GPT2Model</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">48</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">GPT2Model</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">46</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">vocab_size</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">vocab_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">49</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">vocab_size</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">vocab_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">47</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">50</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">48</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">51</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">49</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">embedding_dropout_prob</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_dropout</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">52</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">embedding_dropout_prob</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_dropout</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">50</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention_dropout</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">53</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention_dropout</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">51</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_dropout</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">54</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_dropout</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">52</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">max_sequence_length</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">max_position_embeddings</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">55</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">max_sequence_length</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">max_position_embeddings</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">53</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">checkpoint_activations</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_activations</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">56</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">checkpoint_activations</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_activations</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">54</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">checkpoint_num_layers</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_num_layers</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">57</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">checkpoint_num_layers</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_num_layers</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">55</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">parallel_output</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">58</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">parallel_output</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">56</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">59</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">57</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_data_parallel_rank</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementOperator">==</span> 0:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">60</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_data_parallel_rank</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementOperator">==</span> 0:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">58</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">' &gt; number of parameters on model parallel rank {}: {}'</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">format</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">61</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">' &gt; number of parameters on model parallel rank {}: {}'</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">format</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">59</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_rank</span><span class="TextSegElementOperator">(),</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">62</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_rank</span><span class="TextSegElementOperator">(),</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">60</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">sum</span><span class="TextSegElementOperator">([</span><span class="TextSegElementIdentifier">p</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nelement</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">p</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">parameters</span><span class="TextSegElementOperator">()])),</span> <span class="TextSegElementIdentifier">flush</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">63</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">sum</span><span class="TextSegElementOperator">([</span><span class="TextSegElementIdentifier">p</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nelement</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">p</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">parameters</span><span class="TextSegElementOperator">()])),</span> <span class="TextSegElementIdentifier">flush</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">61</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">64</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">62</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # GPU allocation.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">65</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # GPU allocation.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">63</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">current_device</span><span class="TextSegElementOperator">())</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">66</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">current_device</span><span class="TextSegElementOperator">())</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">64</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">67</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">65</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Fp16 conversion.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">68</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Fp16 conversion.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">66</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fp16</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">69</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fp16</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">67</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">FP16_Module</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">70</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">FP16_Module</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">68</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">71</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">69</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Wrap model for distributed training.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">72</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Wrap model for distributed training.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">70</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">DDP</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">73</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">DDP</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">71</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">74</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">72</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">model</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">75</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">model</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">73</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">76</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">74</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">setup_model</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">77</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">setup_model</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">75</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Setup model and optimizer.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">78</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Setup model and optimizer.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">76</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">79</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">77</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_model</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">80</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_model</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">78</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">81</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">79</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">load</span> <span class="TextSegElementKeyword">is</span> <span class="TextSegElementKeyword">not</span> <span class="TextSegElementKeyword">None</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">82</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">load</span> <span class="TextSegElementKeyword">is</span> <span class="TextSegElementKeyword">not</span> <span class="TextSegElementKeyword">None</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">80</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">load_checkpoint</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">83</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">load_checkpoint</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">81</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">84</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">82</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">85</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">83</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">model</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">86</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">model</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">84</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">87</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">85</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">88</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">86</td>
<td class="TextItemSigMod Wrap">def get_batch(context_tokens, <span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">,</span> args):</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">89</td>
<td class="TextItemSigMod Wrap">def get_batch(context_tokens, args):</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">87</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_tokens</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">90</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_tokens</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">88</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokens</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">view</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">batch_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">-</span>1<span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">contiguous</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">91</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokens</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">view</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">batch_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">-</span>1<span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">contiguous</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">92</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">device</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">device</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">89</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokens</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">to</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">93</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokens</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">to</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">device</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">90</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">94</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">91</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Get the masks and postition ids.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">95</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Get the masks and postition ids.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">92</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">loss_mask</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">position_ids</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_masks_and_position_ids</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">96</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">loss_mask</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">position_ids</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_masks_and_position_ids</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">93</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokens</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">97</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokens</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">94</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">eod_token</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">98</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">eod_token</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">95</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">reset_position_ids</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">99</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">reset_position_ids</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">96</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; args.reset_attention_mask<span class="TextSegSigDiff">)</span></td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">100</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; args.reset_attention_mask<span class="TextSegSigDiff">,</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">101</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">eod_mask_loss</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">97</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">102</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">98</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">tokens</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">position_ids</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">103</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">tokens</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">position_ids</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">99</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">104</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">100</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">top_k_logits</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">logits</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">top_k</span><span class="TextSegElementOperator">=</span>0<span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">top_p</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">0.0</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">filter_value</span><span class="TextSegElementOperator">=-</span><span class="TextSegElementIdentifier">float</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'Inf'</span><span class="TextSegElementOperator">))</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">105</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">top_k_logits</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">logits</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">top_k</span><span class="TextSegElementOperator">=</span>0<span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">top_p</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">0.0</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">filter_value</span><span class="TextSegElementOperator">=-</span><span class="TextSegElementIdentifier">float</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'Inf'</span><span class="TextSegElementOperator">))</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">101</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # This function has been mostly taken from huggingface conversational ai code at</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">106</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # This function has been mostly taken from huggingface conversational ai code at</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">102</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # https://medium.com/huggingface/how-to-build-a-state-of-the-art-conversational-ai-with-transfer-learning-2d818ac26313</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">107</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # https://medium.com/huggingface/how-to-build-a-state-of-the-art-conversational-ai-with-transfer-learning-2d818ac26313</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">103</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">108</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">104</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">top_k</span> <span class="TextSegElementOperator">&gt;</span> 0:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">109</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">top_k</span> <span class="TextSegElementOperator">&gt;</span> 0:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">105</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Remove all tokens with a probability less than the last token of the top-k</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">110</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Remove all tokens with a probability less than the last token of the top-k</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">106</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">indices_to_remove</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">logits</span> <span class="TextSegElementOperator">&lt;</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">topk</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">logits</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">top_k</span><span class="TextSegElementOperator">)[</span>0<span class="TextSegElementOperator">][...,</span> <span class="TextSegElementOperator">-</span>1<span class="TextSegElementOperator">,</span> <span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">111</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">indices_to_remove</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">logits</span> <span class="TextSegElementOperator">&lt;</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">topk</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">logits</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">top_k</span><span class="TextSegElementOperator">)[</span>0<span class="TextSegElementOperator">][...,</span> <span class="TextSegElementOperator">-</span>1<span class="TextSegElementOperator">,</span> <span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">107</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">logits</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">indices_to_remove</span><span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">filter_value</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">112</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">logits</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">indices_to_remove</span><span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">filter_value</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">108</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">113</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">109</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">top_p</span> <span class="TextSegElementOperator">&gt;</span> <span class="TextSegElementNumber">0.0</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">114</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">top_p</span> <span class="TextSegElementOperator">&gt;</span> <span class="TextSegElementNumber">0.0</span>:</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">110</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; #convert to 1D</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">115</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; #convert to 1D</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">111</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logits</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">logits</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">logits</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">()[</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">]).</span><span class="TextSegSigDiff">contiguous</span><span class="TextSegSigDiff">()</span></td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">116</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # logits=logits.view(logits.size()[1]).contiguous()</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">112</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; sorted_logits, sorted_indices = torch.sort(logits, descending=True)</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">117</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; sorted_logits, sorted_indices = torch.sort(logits, descending=True<span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">dim</span><span class="TextSegSigDiff">=-</span><span class="TextSegSigDiff">1</span>)</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">113</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">cumulative_probs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cumsum</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">F</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">softmax</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">sorted_logits</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">dim</span><span class="TextSegElementOperator">=-</span>1<span class="TextSegElementOperator">),</span> <span class="TextSegElementIdentifier">dim</span><span class="TextSegElementOperator">=-</span>1<span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">118</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">cumulative_probs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cumsum</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">F</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">softmax</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">sorted_logits</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">dim</span><span class="TextSegElementOperator">=-</span>1<span class="TextSegElementOperator">),</span> <span class="TextSegElementIdentifier">dim</span><span class="TextSegElementOperator">=-</span>1<span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">114</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">119</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">115</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Remove tokens with cumulative probability above the threshold</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">120</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Remove tokens with cumulative probability above the threshold</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">116</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">sorted_indices_to_remove</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">cumulative_probs</span> <span class="TextSegElementOperator">&gt;</span> <span class="TextSegElementIdentifier">top_p</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">121</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">sorted_indices_to_remove</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">cumulative_probs</span> <span class="TextSegElementOperator">&gt;</span> <span class="TextSegElementIdentifier">top_p</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">117</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Shift the indices to the right to keep also the first token above the threshold</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">122</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Shift the indices to the right to keep also the first token above the threshold</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">118</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">sorted_indices_to_remove</span><span class="TextSegElementOperator">[...,</span> 1:<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">sorted_indices_to_remove</span><span class="TextSegElementOperator">[...,</span> :<span class="TextSegElementOperator">-</span>1<span class="TextSegElementOperator">].</span><span class="TextSegElementIdentifier">clone</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">123</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">sorted_indices_to_remove</span><span class="TextSegElementOperator">[...,</span> 1:<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">sorted_indices_to_remove</span><span class="TextSegElementOperator">[...,</span> :<span class="TextSegElementOperator">-</span>1<span class="TextSegElementOperator">].</span><span class="TextSegElementIdentifier">clone</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">119</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">sorted_indices_to_remove</span><span class="TextSegElementOperator">[...,</span> 0<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> 0</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">124</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">sorted_indices_to_remove</span><span class="TextSegElementOperator">[...,</span> 0<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">=</span> 0</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">125</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">i</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">range</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">sorted_indices</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">))</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">120</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; indices_to_remove = sorted_indices[sorted_indices_to_remove]</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">126</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;<span class="TextSegSigDiff">&nbsp; &nbsp; </span>indices_to_remove = sorted_indices<span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">i</span><span class="TextSegSigDiff">]</span>[sorted_indices_to_remove<span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">i</span><span class="TextSegSigDiff">]</span>]</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">121</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; logits[indices_to_remove] = filter_value</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">127</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;<span class="TextSegSigDiff">&nbsp; &nbsp; </span>logits<span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">i</span><span class="TextSegSigDiff">]</span>[indices_to_remove] = filter_value</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">122</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; #going back to 2D</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">128</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; #going back to 2D</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">123</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logits</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">logits</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">contiguous</span><span class="TextSegSigDiff">()</span></td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">129</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # logits=logits.view(1, -1).contiguous()</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">124</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; </span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">130</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">125</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">logits</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">131</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">logits</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">126</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">132</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">127</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">128</td>
<td class="TextItemSigMod Wrap">def generate_samples(model, tokenizer, args<span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">device</span>):</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">133</td>
<td class="TextItemSigMod Wrap">def generate_samples<span class="TextSegSigDiff">_input_from_file</span>(model, tokenizer, args):</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">134</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">135</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">sample_input_file</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">&quot;&quot;</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">136</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_rank</span><span class="TextSegSigDiff">()</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">137</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;args.sample_input_file CAN NOT BE empty!\n&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">138</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">129</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp;</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">139</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">140</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">141</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_rank</span><span class="TextSegSigDiff">()</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">142</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">fname</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">open</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">sample_input_file</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">&quot;r&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">143</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">all_raw_text</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">fname</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">readlines</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">144</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">input_count</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">len</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">all_raw_text</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">145</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">input_pos</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">0</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">146</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">sample_output_file</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">&quot;&quot;</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">147</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;Argument: sample-output-file can't be empty, setting it to\n&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">148</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\t args.sample_input_file.out&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">149</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">sample_output_file</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">sample_input_file</span><span class="TextSegSigDiff">+</span><span class="TextSegSigDiff">&quot;.out&quot;</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">150</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">fname_out</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">open</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">sample_output_file</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">&quot;w+&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">151</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">130</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_count</span><span class="TextSegElementOperator">=</span>0</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">152</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_count</span><span class="TextSegElementOperator">=</span>0</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">131</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">eval</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">153</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">eval</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">132</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">no_grad</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">154</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">no_grad</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">133</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">while</span> <span class="TextSegElementKeyword">True</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">155</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">while</span> <span class="TextSegElementKeyword">True</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">134</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">distributed</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">barrier</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">group</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_group</span><span class="TextSegElementOperator">())</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">156</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">distributed</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">barrier</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">group</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_group</span><span class="TextSegElementOperator">())</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">135</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">terminate_runs</span><span class="TextSegElementOperator">=</span>0</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">157</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">terminate_runs</span><span class="TextSegElementOperator">=</span>0</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">136</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">158</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">137</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_rank</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementOperator">==</span> 0:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">159</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_rank</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementOperator">==</span> 0:</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">160</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">raw_text</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">all_raw_text</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">input_pos</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">161</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">input_pos</span> <span class="TextSegSigDiff">+=</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">162</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">input_pos</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">input_count</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">163</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">raw_text</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">&quot;stop&quot;</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">164</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">165</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">&quot;stop&quot;</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">raw_text</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">166</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">terminate_runs</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">167</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">168</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">EncodeAsIds</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">raw_text</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">tokenization</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">169</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">len</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">170</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">171</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">&gt;=</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">seq_length</span><span class="TextSegSigDiff">//</span><span class="TextSegSigDiff">2:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">172</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\nContext length&quot;</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">\</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">173</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">&quot;\nPlease give smaller context (half of the sequence length)!&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">174</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">continue</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">175</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">176</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">EncodeAsIds</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;EMPTY TEXT&quot;</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">tokenization</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">177</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">len</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">178</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">179</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">terminate_runs_tensor</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">LongTensor</span><span class="TextSegSigDiff">([</span><span class="TextSegSigDiff">terminate_runs</span><span class="TextSegSigDiff">])</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">180</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">broadcast</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">terminate_runs_tensor</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_src_rank</span><span class="TextSegSigDiff">(),</span> <span class="TextSegSigDiff">group</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_group</span><span class="TextSegSigDiff">())</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">181</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">terminate_runs</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">terminate_runs_tensor</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">].</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">182</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">183</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">terminate_runs</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">1:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">184</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">185</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">186</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">start_time</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">187</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">token_stream</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">get_token_stream</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">],</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">188</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">counter</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">decode_tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">_</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">enumerate</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">token_stream</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">189</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # token_end = decode_tokens.find(&quot;&lt;|endoftext|&gt;&quot;)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">190</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # if token_end &gt; 0:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">191</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #&nbsp; &nbsp;&nbsp; break</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">192</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">decode_tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">_</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">decode_tokens</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">193</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">decode_tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">decode_tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">].</span><span class="TextSegSigDiff">cpu</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">numpy</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">tolist</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">194</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">195</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_rank</span><span class="TextSegSigDiff">()</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">196</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">os</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">system</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">'clear'</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">197</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #print(&quot;\nTaken time {:.2f}\n&quot;.format(time.time() - start_time), flush=True)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">198</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\nContext:&quot;</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">raw_text</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">flush</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">199</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">trim_decode_tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">DecodeIds</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">decode_tokens</span><span class="TextSegSigDiff">)[</span><span class="TextSegSigDiff">len</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">raw_text</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">200</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #print(&quot;\nMegatron-LM:&quot;, trim_decode_tokens.replace(&quot;\n&quot;, &quot;\n\n&quot;), flush=True)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">201</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\nMegatron-LM:&quot;</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">trim_decode_tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">flush</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">202</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">203</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">fname_out</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">write</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\nContext:&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">204</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">fname_out</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">write</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">raw_text</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">205</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">fname_out</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">write</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\n\nMegatron-LM:&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">206</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">fname_out</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">write</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">trim_decode_tokens</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">207</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #fname_out.write(trim_decode_tokens.replace(&quot;\n&quot;, &quot;\n\n&quot;))</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">208</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">fname_out</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">write</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\n&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">209</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">210</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">raw_text</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">None</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">211</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">212</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">barrier</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">group</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_group</span><span class="TextSegSigDiff">())</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">213</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_count</span> <span class="TextSegSigDiff">+=</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">214</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">215</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">generate_samples_interactive</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">216</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">217</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">print_frequency</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">24</span>&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">218</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">219</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">context_count</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">0</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">220</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">eval</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">221</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">with</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">no_grad</span><span class="TextSegSigDiff">()</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">222</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">while</span> <span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">223</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">barrier</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">group</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_group</span><span class="TextSegSigDiff">())</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">224</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">terminate_runs</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">0</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">225</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">226</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_rank</span><span class="TextSegSigDiff">()</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">227</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">os</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">system</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">'clear'</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">138</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">raw_text</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">input</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;\nContext prompt (stop to exit) &gt;&gt;&gt; &quot;</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">228</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">raw_text</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">input</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;\nContext prompt (stop to exit) &gt;&gt;&gt; &quot;</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">139</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">while</span> <span class="TextSegElementKeyword">not</span> <span class="TextSegElementIdentifier">raw_text</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">229</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">while</span> <span class="TextSegElementKeyword">not</span> <span class="TextSegElementIdentifier">raw_text</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">140</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'Prompt should not be empty!'</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">230</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'Prompt should not be empty!'</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">141</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">raw_text</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">input</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;\nContext prompt (stop to exit) &gt;&gt;&gt; &quot;</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">231</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">raw_text</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">input</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;\nContext prompt (stop to exit) &gt;&gt;&gt; &quot;</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">142</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">232</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">143</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementString">&quot;stop&quot;</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">raw_text</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">233</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementString">&quot;stop&quot;</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">raw_text</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">144</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">terminate_runs</span> <span class="TextSegElementOperator">=</span> 1</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">234</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">terminate_runs</span> <span class="TextSegElementOperator">=</span> 1</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">145</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">else</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">235</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">else</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">146</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">EncodeAsIds</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">raw_text</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">tokenization</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">236</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">EncodeAsIds</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">raw_text</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">tokenization</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">147</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_length</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">len</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">context_tokens</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">237</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_length</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">len</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">context_tokens</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">148</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">238</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">149</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">context_length</span> <span class="TextSegElementOperator">&gt;=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seq_length</span><span class="TextSegElementOperator">//</span>2:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">239</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">context_length</span> <span class="TextSegElementOperator">&gt;=</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seq_length</span><span class="TextSegElementOperator">//</span>2:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">150</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;\nContext length&quot;</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">context_length</span><span class="TextSegElementOperator">,</span> \</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">240</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;\nContext length&quot;</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">context_length</span><span class="TextSegElementOperator">,</span> \</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">151</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;\nPlease give smaller context (half of the sequence length)!&quot;</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">241</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;\nPlease give smaller context (half of the sequence length)!&quot;</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">152</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">continue</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">242</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">continue</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">153</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">else</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">243</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">else</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">154</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">EncodeAsIds</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;EMPTY TEXT&quot;</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">tokenization</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">244</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">EncodeAsIds</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;EMPTY TEXT&quot;</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">tokenization</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">155</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_length</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">len</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">context_tokens</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">245</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_length</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">len</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">context_tokens</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">156</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">246</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">157</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">terminate_runs_tensor</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">LongTensor</span><span class="TextSegElementOperator">([</span><span class="TextSegElementIdentifier">terminate_runs</span><span class="TextSegElementOperator">])</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">247</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">terminate_runs_tensor</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cuda</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">LongTensor</span><span class="TextSegElementOperator">([</span><span class="TextSegElementIdentifier">terminate_runs</span><span class="TextSegElementOperator">])</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">158</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">distributed</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">broadcast</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">terminate_runs_tensor</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_src_rank</span><span class="TextSegElementOperator">(),</span> <span class="TextSegElementIdentifier">group</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_group</span><span class="TextSegElementOperator">())</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">248</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">distributed</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">broadcast</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">terminate_runs_tensor</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_src_rank</span><span class="TextSegElementOperator">(),</span> <span class="TextSegElementIdentifier">group</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_group</span><span class="TextSegElementOperator">())</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">159</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">terminate_runs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">terminate_runs_tensor</span><span class="TextSegElementOperator">[</span>0<span class="TextSegElementOperator">].</span><span class="TextSegElementIdentifier">item</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">249</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">terminate_runs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">terminate_runs_tensor</span><span class="TextSegElementOperator">[</span>0<span class="TextSegElementOperator">].</span><span class="TextSegElementIdentifier">item</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">160</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">250</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">161</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">terminate_runs</span> <span class="TextSegElementOperator">==</span> 1:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">251</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">terminate_runs</span> <span class="TextSegElementOperator">==</span> 1:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">162</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">252</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">163</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">253</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">164</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">pad_id</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_command</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">'pad'</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">Id</span></td>
<td class="AlignCenter Wrap">+-</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">165</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">&lt;</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">seq_length</span><span class="TextSegSigDiff">:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">166</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">extend</span><span class="TextSegSigDiff">([</span><span class="TextSegSigDiff">pad_id</span><span class="TextSegSigDiff">]</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">seq_length</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">))</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">167</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">168</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_tokens_tensor</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">LongTensor</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">)</span></td>
<td class="AlignCenter Wrap">+-</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">169</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length_tensor</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">LongTensor</span><span class="TextSegSigDiff">([</span><span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">])</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">170</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">171</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">broadcast</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_length_tensor</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_src_rank</span><span class="TextSegSigDiff">(),</span> <span class="TextSegSigDiff">group</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_group</span><span class="TextSegSigDiff">())</span></td>
<td class="AlignCenter Wrap">+-</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">172</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">broadcast</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_tokens_tensor</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_src_rank</span><span class="TextSegSigDiff">(),</span> <span class="TextSegSigDiff">group</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_group</span><span class="TextSegSigDiff">())</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">173</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">174</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_length_tensor</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">].</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">()</span></td>
<td class="AlignCenter Wrap">+-</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">175</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">attention_mask</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">position_ids</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">get_batch</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_tokens_tensor</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">176</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">177</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">start_time</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">time</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">time</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">254</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">start_time</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">time</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">time</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">178</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">179</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">counter</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">0</span></td>
<td class="AlignCenter Wrap">+-</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">180</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">org_context_length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_length</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">181</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">182</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="TextSegSigDiff">while</span> <span class="TextSegSigDiff">cou</span><span class="TextSegSigDiff">n</span><span class="TextSegSigDiff">t</span><span class="TextSegSigDiff">er</span> <span class="TextSegSigDiff">&lt;</span> (<span class="TextSegSigDiff">org_</span>context_<span class="TextSegSigDiff">l</span>en<span class="TextSegSigDiff">g</span><span class="TextSegSigDiff">th</span> <span class="TextSegSigDiff">+</span> arg<span class="TextSegSigDiff">s</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">out_seq_length</span>)<span class="TextSegSigDiff">:</span></td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">255</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="TextSegSigDiff">t</span><span class="TextSegSigDiff">oken_stream</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">get_token_stream</span>(<span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">[</span>context_<span class="TextSegSigDiff">tok</span>en<span class="TextSegSigDiff">s</span><span class="TextSegSigDiff">],</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> arg<span class="TextSegSigDiff">s</span>)</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">183</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="TextSegSigDiff">&nbsp; &nbsp; </span><span class="TextSegSigDiff">logits</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">m</span>ode<span class="TextSegSigDiff">l</span><span class="TextSegSigDiff">(</span>tokens, <span class="TextSegSigDiff">position_ids</span><span class="TextSegSigDiff">,</span> at<span class="TextSegSigDiff">tentio</span>n_m<span class="TextSegSigDiff">ask</span>)</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">256</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">c</span><span class="TextSegSigDiff">ounter</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">dec</span>ode<span class="TextSegSigDiff">_</span>tokens, <span class="TextSegSigDiff">_</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">enumer</span>at<span class="TextSegSigDiff">e</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">t</span><span class="TextSegSigDiff">oke</span>n_<span class="TextSegSigDiff">strea</span>m)<span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">184</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logits</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">logits</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">]</span> <span class="TextSegSigDiff">/</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">temperature</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">185</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logits</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">top_k_logits</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">logits</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">top_k</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">top_k</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">top_p</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">top_p</span><span class="TextSegSigDiff">)</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">186</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">log_probs</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">F</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">softmax</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">logits</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">dim</span><span class="TextSegSigDiff">=-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">187</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">prev</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">multinomial</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">log_probs</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">num_samples</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">188</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">]</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">prev</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">]</span> </td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">257</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # token_end = decode_tokens.find(&quot;&lt;|endoftext|&gt;&quot;)</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">189</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context</span><span class="TextSegSigDiff">_length</span> <span class="TextSegSigDiff">+=</span> <span class="TextSegSigDiff">1</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">258</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # if token_end &gt; 0:</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">190</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">counter</span> <span class="TextSegSigDiff">+=</span> <span class="TextSegSigDiff">1</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">259</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #&nbsp; &nbsp;&nbsp; break</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">191</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">192</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">output_tokens_list</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">contiguous</span><span class="TextSegSigDiff">()</span></td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">193</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; decode_tokens = <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">D</span>ecode<span class="TextSegSigDiff">Ids</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">output</span>_token<span class="TextSegSigDiff">s_list</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">tolist</span><span class="TextSegSigDiff">())</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">260</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; decode_tokens<span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">_</span> = <span class="TextSegSigDiff">d</span>ecode_token<span class="TextSegSigDiff">s</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">194</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; token<span class="TextSegSigDiff">_end</span> = decode_tokens.<span class="TextSegSigDiff">find</span>(<span class="TextSegSigDiff">&quot;&lt;|endof</span><span class="TextSegSigDiff">text|&gt;&quot;</span>)</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">261</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="TextSegSigDiff">decode_</span>token<span class="TextSegSigDiff">s</span> = decode_tokens<span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">].</span><span class="TextSegSigDiff">cpu</span><span class="TextSegSigDiff">()</span>.<span class="TextSegSigDiff">numpy</span>(<span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">t</span><span class="TextSegSigDiff">olist</span><span class="TextSegSigDiff">(</span>)</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">195</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">262</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">196</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">197</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if mpu.get_model_parallel_rank() == 0 and <span class="TextSegSigDiff">(</span>counter % <span class="TextSegSigDiff">16</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0</span> <span class="TextSegSigDiff">or</span> <span class="TextSegSigDiff">tok</span><span class="TextSegSigDiff">en_</span>en<span class="TextSegSigDiff">d</span> <span class="TextSegSigDiff">!</span>= <span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span>:</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">263</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if mpu.get_model_parallel_rank() == 0 and counter % <span class="TextSegSigDiff">prin</span><span class="TextSegSigDiff">t_frequ</span>en<span class="TextSegSigDiff">cy</span> <span class="TextSegSigDiff">=</span>= <span class="TextSegSigDiff">0</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">198</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; os.system('clear')</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">264</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;<span class="TextSegSigDiff"> </span>os.system('clear')</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">199</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\nTaken time {:.2f}\n&quot;</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">format</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">()</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">start_time</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">flush</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">265</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #print(&quot;\nTaken time {:.2f}\n&quot;.format(time.time() - start_time), flush=True)</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">200</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print(&quot;\nContext:&quot;, raw_text, flush=True)</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">266</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;<span class="TextSegSigDiff"> </span>print(&quot;\nContext:&quot;, raw_text, flush=True)</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">201</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trim_decode_tokens = decode_tokens[len(raw_text):<span class="TextSegSigDiff">decode_tokens</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">find</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;&lt;|endoftext|&gt;&quot;</span><span class="TextSegSigDiff">)</span>]</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">267</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;<span class="TextSegSigDiff"> </span>trim_decode_tokens = <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">Deco</span>de<span class="TextSegSigDiff">Ids</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">de</span>code_tokens<span class="TextSegSigDiff">)</span>[len(raw_text):]</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">202</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\nGPT2:&quot;</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">trim_decode_tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">flush</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">268</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #print(&quot;\nGPT2:&quot;, trim_decode_tokens, flush=True)</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">203</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">token</span><span class="TextSegSigDiff">_end</span> <span class="TextSegSigDiff">!</span><span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">269</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #print(&quot;\nMegatron-LM:&quot;, trim_decode_tokens.replace(&quot;\n&quot;, &quot;\n\n&quot;), flush=True)</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">204</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="TextSegSigDiff">b</span><span class="TextSegSigDiff">r</span><span class="TextSegSigDiff">eak</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">270</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;<span class="TextSegSigDiff"> </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\nMegatron-LM:&quot;</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">trim_decode_tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">flush</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">205</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">271</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">206</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_rank</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementOperator">==</span> 0:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">272</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_rank</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementOperator">==</span> 0:</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">207</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">os</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">system</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'clear'</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">273</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">os</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">system</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'clear'</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">208</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\nTaken time {:.2f}\n&quot;</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">format</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">()</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">start_time</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">flush</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">)</span></td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">274</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #print(&quot;\nTaken time {:.2f}\n&quot;.format(time.time() - start_time), flush=True)</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">209</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;\nContext:&quot;</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">raw_text</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">flush</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">275</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;\nContext:&quot;</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">raw_text</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">flush</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">210</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="TextSegSigDiff">output</span>_token<span class="TextSegSigDiff">s_list</span> = token<span class="TextSegSigDiff">s</span>.<span class="TextSegSigDiff">vi</span><span class="TextSegSigDiff">ew</span>(<span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">).</span>co<span class="TextSegSigDiff">n</span><span class="TextSegSigDiff">tiguou</span>s()</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">276</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="TextSegSigDiff">trim_decode</span>_token<span class="TextSegSigDiff">s</span> = token<span class="TextSegSigDiff">izer</span>.<span class="TextSegSigDiff">DecodeIds</span>(<span class="TextSegSigDiff">de</span>co<span class="TextSegSigDiff">de_t</span><span class="TextSegSigDiff">oken</span>s<span class="TextSegSigDiff">)[</span><span class="TextSegSigDiff">len</span>(<span class="TextSegSigDiff">raw_text</span>)<span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">211</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">decode_tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">DecodeIds</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">output_tokens_list</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">tolist</span><span class="TextSegSigDiff">()</span><span class="TextSegSigDiff">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">277</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #print(&quot;\nGPT2:&quot;, trim_decode_tokens, flush=True)</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">212</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">trim_decode_tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">decode_tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">len</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">raw_text</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">decode_tokens</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">find</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;&lt;|endoftext|&gt;&quot;</span><span class="TextSegSigDiff">)]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">278</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; #print(&quot;\nMegatron-LM:&quot;, trim_decode_tokens.replace(&quot;\n&quot;, &quot;\n\n&quot;), flush=True)</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">213</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print(&quot;\n<span class="TextSegSigDiff">GPT2</span>:&quot;, trim_decode_tokens, flush=True)</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">279</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print(&quot;\n<span class="TextSegSigDiff">Megatron-LM</span>:&quot;, trim_decode_tokens, flush=True)</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">280</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">214</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">raw_text</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementKeyword">None</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">281</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">raw_text</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementKeyword">None</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">215</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">282</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">216</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">distributed</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">barrier</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">group</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_group</span><span class="TextSegElementOperator">())</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">283</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">distributed</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">barrier</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">group</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">mpu</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_model_parallel_group</span><span class="TextSegElementOperator">())</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">217</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_count</span> <span class="TextSegElementOperator">+=</span> 1</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">284</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_count</span> <span class="TextSegElementOperator">+=</span> 1</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">285</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">286</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_rank</span><span class="TextSegSigDiff">()</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">287</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">input</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">&quot;\nPress any key to continue &gt;&gt;&gt;&quot;</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">288</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">289</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">generate_samples_unconditional</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">290</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">num_samples</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">num_samples</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">291</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">context_tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">[[</span><span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_command</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">'pad'</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">Id</span><span class="TextSegSigDiff">]</span> <span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">_</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">range</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">batch_size</span><span class="TextSegSigDiff">)]</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">292</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">samples</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">[]</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">293</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # with open(args.genfile, 'w') as f:</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">294</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">ctr</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">0</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">295</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">while</span> <span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">296</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">start_time</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">297</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">token_stream</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">get_token_stream</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">copy</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">deepcopy</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">298</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">pass</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">299</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # token_stream = list(get_token_stream(model, copy.deepcopy(context_tokens), tokenizer, args))</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">300</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">ctr</span><span class="TextSegSigDiff">%</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">log_interval</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">301</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">print</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">'Avg s/batch:'</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">()-</span><span class="TextSegSigDiff">start_time</span><span class="TextSegSigDiff">)/</span><span class="TextSegSigDiff">min</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">log_interval</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">ctr</span><span class="TextSegSigDiff">+</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">))</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">302</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">start_time</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">time</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">303</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">len</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">token_stream</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">304</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">token_batch</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">token_stream</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">].</span><span class="TextSegSigDiff">cpu</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">numpy</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">tolist</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">305</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">length_batch</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">token_stream</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">].</span><span class="TextSegSigDiff">cpu</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">numpy</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">tolist</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">306</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">length</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">zip</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">token_batch</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">length_batch</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">307</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">1:</span><span class="TextSegSigDiff">length</span><span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">308</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">text</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">DecodeIds</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">309</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">is_finished</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">length</span> <span class="TextSegSigDiff">&lt;</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">seq_length</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">310</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">datum</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">{</span><span class="TextSegSigDiff">'text'</span><span class="TextSegSigDiff">:</span> <span class="TextSegSigDiff">text</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">'length'</span><span class="TextSegSigDiff">:</span> <span class="TextSegSigDiff">length</span><span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">'finished'</span><span class="TextSegSigDiff">:</span> <span class="TextSegSigDiff">is_finished</span><span class="TextSegSigDiff">}</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">311</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">yield</span> <span class="TextSegSigDiff">datum</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">312</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">ctr</span> <span class="TextSegSigDiff">+=</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">313</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">ctr</span> <span class="TextSegSigDiff">&gt;=</span> <span class="TextSegSigDiff">num_samples</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">314</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">break</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">315</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">ctr</span> <span class="TextSegSigDiff">&gt;=</span> <span class="TextSegSigDiff">num_samples</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">316</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">break</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">317</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">318</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">write_and_generate_samples_unconditional</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">319</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">assert</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">genfile</span> <span class="TextSegSigDiff">is</span> <span class="TextSegSigDiff">not</span> <span class="TextSegSigDiff">None</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">320</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">with</span> <span class="TextSegSigDiff">open</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">genfile</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">'w'</span><span class="TextSegSigDiff">)</span> <span class="TextSegSigDiff">as</span> <span class="TextSegSigDiff">f</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">321</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">datum</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">generate_samples_unconditional</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">322</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">f</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">write</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">json</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">dumps</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">datum</span><span class="TextSegSigDiff">)+</span><span class="TextSegSigDiff">'\n'</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">323</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">324</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">pad_batch</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">batch</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">325</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">pad_id</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_command</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">'pad'</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">Id</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">326</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">context_lengths</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">[]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">327</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">tokens</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">batch</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">328</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">len</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">329</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">&lt;</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">seq_length</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">330</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">extend</span><span class="TextSegSigDiff">([</span><span class="TextSegSigDiff">pad_id</span><span class="TextSegSigDiff">]*(</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">seq_length</span><span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">))</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">331</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_lengths</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">append</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">332</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span> <span class="TextSegSigDiff">batch</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_lengths</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">333</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">334</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">get_token_stream</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_lengths</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">None</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">generate</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">335</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegSigDiff">stop_on_end_of_comment</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">336</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">calculated_context_lengths</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">pad_batch</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">337</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">context_lengths</span> <span class="TextSegSigDiff">is</span> <span class="TextSegSigDiff">None</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">338</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_lengths</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">calculated_context_lengths</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">339</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">340</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">context_tokens_tensor</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">LongTensor</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">341</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length_tensor</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">LongTensor</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_lengths</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">342</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">343</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">broadcast</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_length_tensor</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_src_rank</span><span class="TextSegSigDiff">(),</span> <span class="TextSegSigDiff">group</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_group</span><span class="TextSegSigDiff">())</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">344</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">broadcast</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_tokens_tensor</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_src_rank</span><span class="TextSegSigDiff">(),</span> <span class="TextSegSigDiff">group</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_group</span><span class="TextSegSigDiff">())</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">345</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">346</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_length_tensor</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">min</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">347</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">attention_mask</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">position_ids</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">get_batch</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_tokens_tensor</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">348</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">349</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">batch_token_iterator</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">sample_sequence_batch</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_tokens_tensor</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_length_tensor</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">attention_mask</span><span class="TextSegSigDiff">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">350</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegSigDiff">position_ids</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">generate</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">generate</span><span class="TextSegSigDiff">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">351</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegSigDiff">stop_on_end_of_comment</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">stop_on_end_of_comment</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">352</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">for</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">lengths</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">logprob</span> <span class="TextSegSigDiff">in</span> <span class="TextSegSigDiff">batch_token_iterator</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">353</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">+=</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">354</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">yield</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">],</span> <span class="TextSegSigDiff">lengths</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">logprob</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">355</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">356</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">357</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">switch</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">val1</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">val2</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">boolean</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">358</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">boolean</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">boolean</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">type_as</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">val1</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">359</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">boolean</span><span class="TextSegSigDiff">)*</span><span class="TextSegSigDiff">val1</span> <span class="TextSegSigDiff">+</span> <span class="TextSegSigDiff">boolean</span><span class="TextSegSigDiff">*</span><span class="TextSegSigDiff">val2</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">360</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">361</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">362</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">vertical_tile</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">t</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">num_repetitions</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">363</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span> <span class="TextSegSigDiff">t</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">repeat</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">num_repetitions</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">t</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">()[</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">])</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">364</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">365</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">366</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">horizontal_tile</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">t</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">num_repetitions</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">367</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">return</span> <span class="TextSegSigDiff">vertical_tile</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">t</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">unsqueeze</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">num_repetitions</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">368</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">369</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">370</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">def</span> <span class="TextSegSigDiff">sample_sequence_batch</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_lengths</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">attention_mask</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">position_ids</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">371</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">maxlen</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">None</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">generate</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">stop_on_end_of_comment</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">372</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">eval</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">373</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">with</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">no_grad</span><span class="TextSegSigDiff">()</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">374</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_lengths</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">min</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">item</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">375</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">eos_id</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_command</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">'eos'</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">Id</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">376</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">eoc_id</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_command</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">'eoc'</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">Id</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">377</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">378</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">counter</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">0</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">379</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">org_context_length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_length</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">380</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">381</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">layer_past</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">None</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">382</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">batch_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_tokens</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">383</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">is_done</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">zeros</span><span class="TextSegSigDiff">([</span><span class="TextSegSigDiff">batch_size</span><span class="TextSegSigDiff">]).</span><span class="TextSegSigDiff">bool</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">384</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_tokens</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">385</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">maxlen</span> <span class="TextSegSigDiff">is</span> <span class="TextSegSigDiff">None</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">386</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">generate</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">387</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">maxlen</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">seq_length</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">388</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">maxlen</span> <span class="TextSegSigDiff">&gt;</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">org_context_length</span> <span class="TextSegSigDiff">+</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">out_seq_length</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">389</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">maxlen</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">org_context_length</span> <span class="TextSegSigDiff">+</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">out_seq_length</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">390</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">391</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">maxlen</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">max_position_embeddings</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">392</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">393</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">lengths</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">ones</span><span class="TextSegSigDiff">([</span><span class="TextSegSigDiff">batch_size</span><span class="TextSegSigDiff">]).</span><span class="TextSegSigDiff">long</span><span class="TextSegSigDiff">().</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">()*</span><span class="TextSegSigDiff">maxlen</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">394</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logprob_sums</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">None</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">395</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">396</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">while</span> <span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">&lt;=</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">maxlen</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">397</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">398</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">recompute</span> <span class="TextSegSigDiff">or</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">399</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logits_for_device</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">position_ids</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">attention_mask</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">400</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logits_for_device</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">logits_for_device</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">401</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">402</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">counter</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">403</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens2use</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">404</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">positions2use</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">position_ids</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">405</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">406</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens2use</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">].</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">batch_size</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">407</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">positions2use</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">position_ids</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">].</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">batch_size</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">408</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logits_for_device</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">layer_past</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">tokens2use</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">positions2use</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">attention_mask</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">layer_past</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">layer_past</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">get_present</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">409</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logits_for_device</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">logits_for_device</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">].</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">batch_size</span><span class="TextSegSigDiff">,-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">contiguous</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">410</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">411</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # Get the partition's vocab indices</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">412</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">get_vocab_range</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">VocabUtility</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">vocab_range_from_per_partition_vocab_size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">413</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">partition_vocab_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">logits_for_device</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">()[-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">414</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">rank</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_rank</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">415</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">world_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_world_size</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">416</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">vocab_start_index</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">vocab_end_index</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">get_vocab_range</span><span class="TextSegSigDiff">(</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">417</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">partition_vocab_size</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">rank</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">world_size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">418</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">419</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">all_logits</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">zeros</span><span class="TextSegSigDiff">((</span><span class="TextSegSigDiff">logits_for_device</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">()[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">],</span> <span class="TextSegSigDiff">partition_vocab_size</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">world_size</span><span class="TextSegSigDiff">),</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">420</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegSigDiff">dtype</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">logits_for_device</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">dtype</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">logits_for_device</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">421</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">all_logits</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">vocab_start_index</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">vocab_end_index</span><span class="TextSegSigDiff">]</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">logits_for_device</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">422</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">all_reduce</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">all_logits</span><span class="TextSegSigDiff">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">423</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegSigDiff">op</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">distributed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">ReduceOp</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">SUM</span><span class="TextSegSigDiff">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">424</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegSigDiff">group</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">mpu</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_model_parallel_group</span><span class="TextSegSigDiff">())</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">425</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">original_logits</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">all_logits</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">num_tokens</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">426</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">427</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">generate</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">428</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">429</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">vertical_tile</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">430</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">position_ids</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">vertical_tile</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">position_ids</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">431</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">prev</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">topk</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">original_logits</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">indices</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">432</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">original_logits</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">vertical_tile</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">original_logits</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">433</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_lengths</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">horizontal_tile</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">context_lengths</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">434</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">lengths</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">horizontal_tile</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">lengths</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">435</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">is_done</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">horizontal_tile</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">is_done</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">436</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">logprob_sums</span> <span class="TextSegSigDiff">is</span> <span class="TextSegSigDiff">not</span> <span class="TextSegSigDiff">None</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">437</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logprob_sums</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">horizontal_tile</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">logprob_sums</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">438</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">439</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">greedy</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">440</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">prev</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">argmax</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">original_logits</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">dim</span><span class="TextSegSigDiff">=-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">441</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">442</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">scaled_logits</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">original_logits</span> <span class="TextSegSigDiff">/</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">temperature</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">443</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">scaled_logits</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">top_k_logits</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">scaled_logits</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">top_k</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">top_k</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">top_p</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">top_p</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">444</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">log_probs</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">F</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">softmax</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">scaled_logits</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">dim</span><span class="TextSegSigDiff">=-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">445</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">prev</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">multinomial</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">log_probs</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">num_samples</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">446</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">447</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">prev</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">448</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">449</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">started</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_lengths</span> <span class="TextSegSigDiff">&lt;=</span> <span class="TextSegSigDiff">context_length</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">450</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logprob</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">flatten</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">gather</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">original_logits</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">unsqueeze</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">prev</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)))</span> <span class="TextSegSigDiff">-</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">451</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">log</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">sum</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">exp</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">original_logits</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)))</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">started</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">float</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">452</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">453</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">generate</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">454</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">]</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">switch</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">:</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">context_length</span><span class="TextSegSigDiff">].</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">prev</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">started</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">455</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">+=</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">456</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">counter</span> <span class="TextSegSigDiff">+=</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">457</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">458</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">stop_on_end_of_comment</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">459</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">done_token</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">prev</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">eos_id</span><span class="TextSegSigDiff">)</span> <span class="TextSegSigDiff">|</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">prev</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">eoc_id</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">460</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">461</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">done_token</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">prev</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">eos_id</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">462</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">generate</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">463</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">current_length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_length</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">464</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">465</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">current_length</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">466</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">467</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">lengths</span><span class="TextSegSigDiff">[(~</span><span class="TextSegSigDiff">is_done</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)]</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">current_length</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">468</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logprob</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">is_done</span><span class="TextSegSigDiff">]</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">0</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">469</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">logprob_sums</span> <span class="TextSegSigDiff">is</span> <span class="TextSegSigDiff">None</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">470</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logprob_sums</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">logprob</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">471</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">472</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logprob_sums</span> <span class="TextSegSigDiff">+=</span> <span class="TextSegSigDiff">logprob</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">473</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">474</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">all</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">is_done</span> <span class="TextSegSigDiff">|</span> <span class="TextSegSigDiff">done_token</span><span class="TextSegSigDiff">)</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">475</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">yield</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">lengths</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">logprob_sums</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">476</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">break</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">477</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">478</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">generate</span> <span class="TextSegSigDiff">and</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span> <span class="TextSegSigDiff">and</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">()[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">]</span> <span class="TextSegSigDiff">&gt;</span> <span class="TextSegSigDiff">batch_size</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span> <span class="TextSegSigDiff">and</span> <span class="TextSegSigDiff">\</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">479</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_length</span> <span class="TextSegSigDiff">&lt;=</span> <span class="TextSegSigDiff">maxlen</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">480</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">average_logprobs</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">logprob_sums</span> <span class="TextSegSigDiff">/</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">lengths</span> <span class="TextSegSigDiff">-</span> <span class="TextSegSigDiff">context_lengths</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">float</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">481</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">average_logprobs</span> <span class="TextSegSigDiff">-=</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">diversity_rate</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">\</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">482</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">sort</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">average_logprobs</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">batch_size</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">),</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">483</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">descending</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">True</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">indices</span> <span class="TextSegSigDiff">+</span> <span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">float</span><span class="TextSegSigDiff">()</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">(~</span><span class="TextSegSigDiff">is_done</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">float</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">484</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">not_selectable</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">is_done</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">clone</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">485</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">not_selectable</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">arange</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">not_selectable</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">()[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">],</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">)]</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">False</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">486</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">average_logprobs</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">not_selectable</span><span class="TextSegSigDiff">]</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">float</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">'-inf'</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">487</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">top_k_logprobs</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">topk</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">average_logprobs</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">batch_size</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">),</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span><span class="TextSegSigDiff">).</span><span class="TextSegSigDiff">indices</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">view</span><span class="TextSegSigDiff">(-</span><span class="TextSegSigDiff">1</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">488</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">beam_size_squared</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">beam_size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">489</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">best_indices</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">top_k_logprobs</span> <span class="TextSegSigDiff">+</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">arange</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">top_k_logprobs</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">size</span><span class="TextSegSigDiff">()[</span><span class="TextSegSigDiff">0</span><span class="TextSegSigDiff">],</span> <span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">=</span><span class="TextSegSigDiff">top_k_logprobs</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">device</span><span class="TextSegSigDiff">)</span> <span class="TextSegSigDiff">/</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">490</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegSigDiff">beam_size_squared</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">beam_size_squared</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">491</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">tokens</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">best_indices</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">492</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">position_ids</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">position_ids</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">best_indices</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">493</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">context_lengths</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">context_lengths</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">best_indices</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">494</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">lengths</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">lengths</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">best_indices</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">495</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">is_done</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">is_done</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">best_indices</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">496</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">done_token</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">done_token</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">best_indices</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">497</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">logprob_sums</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">logprob_sums</span><span class="TextSegSigDiff">[</span><span class="TextSegSigDiff">best_indices</span><span class="TextSegSigDiff">]</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">498</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">499</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">is_done</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">is_done</span> <span class="TextSegSigDiff">|</span> <span class="TextSegSigDiff">done_token</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">500</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">done</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">all</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">is_done</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">501</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">502</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">yield</span> <span class="TextSegSigDiff">tokens</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">lengths</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">logprob_sums</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">503</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">done</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">504</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">break</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">218</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">505</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">219</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">prepare_tokenizer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">506</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">prepare_tokenizer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">220</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">507</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">221</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokenizer_args</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementOperator">{</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">508</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokenizer_args</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementOperator">{</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">222</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'tokenizer_type'</span>: <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tokenizer_type</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">509</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'tokenizer_type'</span>: <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tokenizer_type</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">223</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'corpus'</span>: <span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">510</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'corpus'</span>: <span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">224</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'model_path'</span>: <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tokenizer_path</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">511</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'model_path'</span>: <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tokenizer_path</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">225</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'vocab_size'</span>: <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">vocab_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">512</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'vocab_size'</span>: <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">vocab_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">226</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'model_type'</span>: <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tokenizer_model_type</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">513</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'model_type'</span>: <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tokenizer_model_type</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">227</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'cache_dir'</span>: <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cache_dir</span><span class="TextSegElementOperator">}</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">514</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">'cache_dir'</span>: <span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cache_dir</span><span class="TextSegElementOperator">}</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">228</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokenizer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">make_tokenizer</span><span class="TextSegElementOperator">(**</span><span class="TextSegElementIdentifier">tokenizer_args</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">515</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokenizer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">make_tokenizer</span><span class="TextSegElementOperator">(**</span><span class="TextSegElementIdentifier">tokenizer_args</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">229</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">516</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">230</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tokenizer_num_tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_tokens</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">517</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tokenizer_num_tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_tokens</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">231</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tokenizer_num_type_tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_type_tokens</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">518</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tokenizer_num_type_tokens</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_type_tokens</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">232</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">eod_token</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_command</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'eos'</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">Id</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">519</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">eod_token</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">get_command</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'eos'</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">Id</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">233</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">520</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">234</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">after</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_tokens</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">521</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">after</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tokenizer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_tokens</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">522</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">multiple</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">make_vocab_size_divisible_by</span> <span class="TextSegSigDiff">*</span> <span class="TextSegSigDiff">\</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">235</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp;&nbsp; <span class="TextSegSigDiff">while</span> <span class="TextSegSigDiff">after</span> <span class="TextSegSigDiff">%</span> mpu.get_model_parallel_world_size() <span class="TextSegSigDiff">!=</span> <span class="TextSegSigDiff">0:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">523</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp;<span class="TextSegSigDiff">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff"> </span><span class="TextSegSigDiff"> </span>mpu.get_model_parallel_world_size()</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">524</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">multiple</span> <span class="TextSegSigDiff">!=</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">525</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">while</span> <span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">after</span> <span class="TextSegSigDiff">%</span> <span class="TextSegSigDiff">multiple</span><span class="TextSegSigDiff">)</span> <span class="TextSegSigDiff">!=</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">236</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; after += 1</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">526</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;<span class="TextSegSigDiff">&nbsp; &nbsp; </span>after += 1</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">237</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">527</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">238</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">vocab_size</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">after</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">528</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">vocab_size</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">after</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">239</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;prepare tokenizer done&quot;</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">flush</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">529</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">&quot;prepare tokenizer done&quot;</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">flush</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">240</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">530</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">241</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">tokenizer</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">531</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">tokenizer</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">242</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">532</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">243</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">main</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">533</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">main</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">244</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Main training program.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">534</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Main training program.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">245</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">535</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">246</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'Generate Samples'</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">536</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">print</span><span class="TextSegElementOperator">(</span><span class="TextSegElementString">'Generate Samples'</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">247</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">537</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">248</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Disable CuDNN.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">538</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Disable CuDNN.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">249</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">backends</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cudnn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">enabled</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementKeyword">False</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">539</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">backends</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">cudnn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">enabled</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementKeyword">False</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">250</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">540</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">251</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Timer.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">541</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Timer.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">252</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">timers</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">Timers</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">542</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">timers</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">Timers</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">253</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">543</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">254</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Arguments.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">544</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Arguments.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">255</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_args</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">545</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">args</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_args</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">256</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">546</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">257</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Pytorch distributed.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">547</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Pytorch distributed.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">258</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">initialize_distributed</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">548</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">initialize_distributed</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">259</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">549</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">260</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Random seeds for reproducability.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">550</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Random seeds for reproducability.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">261</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">set_random_seed</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">551</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">set_random_seed</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">seed</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">262</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">552</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">263</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; #get the tokenizer</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">553</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; #get the tokenizer</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">264</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokenizer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">prepare_tokenizer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">554</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tokenizer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">prepare_tokenizer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">265</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">555</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">266</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Model, optimizer, and learning rate.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">556</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; # Model, optimizer, and learning rate.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">267</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">setup_model</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">557</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">model</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">setup_model</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">args</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">268</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">558</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">269</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; #setting default batch size to 1</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">559</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; #setting default batch size to 1</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">270</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">batch_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">1</span></td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">560</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp;&nbsp; # args.batch_size = 1</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">271</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">561</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">562</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">device</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">current_device</span><span class="TextSegSigDiff">()</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">563</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">272</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; #generate samples</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">564</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp;&nbsp; #generate samples</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&lt;&gt;</td>
<td class="TextItemNum AlignRight Wrap">565</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">num_samples</span> <span class="TextSegSigDiff">==</span> <span class="TextSegSigDiff">0:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">566</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">batch_size</span> <span class="TextSegSigDiff">=</span> <span class="TextSegSigDiff">1</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">567</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">sample_input_file</span> <span class="TextSegSigDiff">!=</span> <span class="TextSegSigDiff">&quot;&quot;</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">568</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">generate_samples_input_from_file</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">569</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">273</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp;&nbsp; generate_samples(model, tokenizer, args<span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">torch</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">cuda</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">current_device</span><span class="TextSegSigDiff">()</span>)</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">570</td>
<td class="TextItemSigMod Wrap">&nbsp;&nbsp; &nbsp;<span class="TextSegSigDiff">&nbsp; &nbsp; &nbsp; &nbsp; </span>generate_samples<span class="TextSegSigDiff">_interactive</span>(model, tokenizer, args)</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">571</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp;&nbsp; </span><span class="TextSegSigDiff">else</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">572</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">write_and_generate_samples_unconditional</span><span class="TextSegSigDiff">(</span><span class="TextSegSigDiff">model</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">tokenizer</span><span class="TextSegSigDiff">,</span> <span class="TextSegSigDiff">args</span><span class="TextSegSigDiff">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">274</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp;</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">573</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">275</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">574</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">276</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">__name__</span> <span class="TextSegElementOperator">==</span> <span class="TextSegElementString">&quot;__main__&quot;</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">575</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">__name__</span> <span class="TextSegElementOperator">==</span> <span class="TextSegElementString">&quot;__main__&quot;</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">277</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">main</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">576</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">main</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">278</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">577</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">279</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">578</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">280</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">579</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
</table>
<br>
</body>
</html>
