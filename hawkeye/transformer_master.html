<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style>
.AlignLeft { text-align: left; }
.AlignCenter { text-align: center; }
.AlignRight { text-align: right; }
.Wrap { white-space: nowrap; }
body { font-family: sans-serif; font-size: 11pt; }
img.AutoScale { max-width: 100%; max-height: 100%; }
td { vertical-align: top; padding-left: 4px; padding-right: 4px; }

tr.SectionGap td { font-size: 4px; border-left: none; border-top: none; border-bottom: 1px solid Black; border-right: 1px solid Black; }
tr.SectionAll td { border-left: none; border-top: none; border-bottom: 1px solid Black; border-right: 1px solid Black; }
tr.SectionBegin td { border-left: none; border-top: none; border-right: 1px solid Black; }
tr.SectionEnd td { border-left: none; border-top: none; border-bottom: 1px solid Black; border-right: 1px solid Black; }
tr.SectionMiddle td { border-left: none; border-top: none; border-right: 1px solid Black; }
tr.SubsectionAll td { border-left: none; border-top: none; border-bottom: 1px solid Gray; border-right: 1px solid Black; }
tr.SubsectionEnd td { border-left: none; border-top: none; border-bottom: 1px solid Gray; border-right: 1px solid Black; }
table.fc { border-top: 1px solid Black; border-left: 1px solid Black; width: 100%; font-family: monospace; font-size: 10pt; }
td.TextItemInsigMod { color: #000000; background-color: #EEEEFF; }
td.TextItemInsigOrphan { color: #000000; background-color: #FAEEFF; }
td.TextItemNum { color: #696969; background-color: #ECECEC; }
td.TextItemSame { color: #000000; background-color: #FFFFFF; }
td.TextItemSigMod { color: #000000; background-color: #FFE3E3; }
td.TextItemSigOrphan { color: #000000; background-color: #F1E3FF; }
.TextSegInsigDiff { color: #0000FF; }
.TextSegReplacedDiff { color: #0000FF; font-style: italic; }
.TextSegSigDiff { color: #FF0000; }
td.TextItemInsigAdd { color: #000000; background-color: #EEEEFF; }
td.TextItemInsigDel { color: #000000; background-color: #EEEEFF; text-decoration: line-through; }
td.TextItemSigAdd { color: #000000; background-color: #FFE3E3; }
td.TextItemSigDel { color: #000000; background-color: #FFE3E3; text-decoration: line-through; }
.TextSegElementKeyword { font-weight: bold; }
.TextSegElementIdentifier { }
.TextSegElementNumber { color: #2E9269; }
.TextSegElementString { color: #3A7726; }
.TextSegElementComment { color: #786A41; }
.TextSegElementOperator { }
.TextSegElementIndentation { }
</style>
<title>transformer_master</title>
</head>
<body>
transformer_master<br>
Produced: 9/27/20 8:00:55 PM<br>
&nbsp; &nbsp;
<br>
Mode:&nbsp; All, With Context &nbsp;
<br>
Left file: /Users/msmolyak/Projects/Cora/Megatron-LM/mpu/transformer.py &nbsp;
<br>
Right file: /Users/msmolyak/Projects/Cora/DeepSpeedExamples/Megatron-LM/mpu/transformer.py &nbsp;
<br>
<table class="fc" cellspacing="0" cellpadding="0">
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">1</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># coding=utf-8</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">1</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># coding=utf-8</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">2</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Copyright (c) 2019, NVIDIA CORPORATION.&nbsp; All rights reserved.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">2</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Copyright (c) 2019, NVIDIA CORPORATION.&nbsp; All rights reserved.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">3</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">3</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">4</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">4</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">5</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># you may not use this file except in compliance with the License.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">5</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># you may not use this file except in compliance with the License.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">6</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># You may obtain a copy of the License at</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">6</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># You may obtain a copy of the License at</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">7</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">7</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">8</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#&nbsp; &nbsp;&nbsp; http://www.apache.org/licenses/LICENSE-2.0</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">8</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#&nbsp; &nbsp;&nbsp; http://www.apache.org/licenses/LICENSE-2.0</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">9</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">9</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">#</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">10</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Unless required by applicable law or agreed to in writing, software</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">10</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># Unless required by applicable law or agreed to in writing, software</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">11</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">11</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">12</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">12</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">13</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># See the License for the specific language governing permissions and</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">13</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># See the License for the specific language governing permissions and</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">14</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># limitations under the License.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">14</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment"># limitations under the License.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">15</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">15</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">16</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&quot;&quot;&quot;Transformer.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">16</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&quot;&quot;&quot;Transformer.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">17</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">17</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">18</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">math</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">18</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">math</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">19</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">19</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">20</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">torch</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">20</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">torch</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">21</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">init</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">init</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">21</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">init</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">init</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">22</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">apex</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">normalization</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fused_layer_norm</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">FusedLayerNorm</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">LayerNorm</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">22</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementIdentifier">apex</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">normalization</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">fused_layer_norm</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">FusedLayerNorm</span> <span class="TextSegElementKeyword">as</span> <span class="TextSegElementIdentifier">LayerNorm</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">23</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">23</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">24</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">initialize</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_model_parallel_world_size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">24</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">initialize</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_model_parallel_world_size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">25</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">ColumnParallelLinear</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">25</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">ColumnParallelLinear</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">26</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">RowParallelLinear</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">26</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">RowParallelLinear</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">27</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">mappings</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">gather_from_model_parallel_region</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">27</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">mappings</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">gather_from_model_parallel_region</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">28</td>
<td class="TextItemInsigMod Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">29</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">import</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">deepspeed</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">30</td>
<td class="TextItemInsigMod Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">28</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">random</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">checkpoint</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">31</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">random</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">checkpoint</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">29</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">random</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">32</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">random</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span></td>
</tr>
<tr class="SectionAll">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">33</td>
<td class="TextItemInsigMod Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">30</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">divide</span></td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">34</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">divide</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">31</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">split_tensor_along_last_dim</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">35</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">from</span> <span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">utils</span> <span class="TextSegElementKeyword">import</span> <span class="TextSegElementIdentifier">split_tensor_along_last_dim</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">32</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">36</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">33</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">37</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">34</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">GPT2ParallelSelfAttention</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">38</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">GPT2ParallelSelfAttention</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">35</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Parallel self-attention layer for GPT2.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">39</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Parallel self-attention layer for GPT2.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">36</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">40</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">37</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Self-attention layer takes input with size [b, s, h] where b is</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">41</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Self-attention layer takes input with size [b, s, h] where b is</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">38</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; the batch size, s is the sequence lenght, and h is the hidden size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">42</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; the batch size, s is the sequence lenght, and h is the hidden size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">39</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; and creates output of the same size.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">43</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; and creates output of the same size.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">40</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">44</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">41</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: total hidden size of the layer (h).</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">45</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: total hidden size of the layer (h).</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">42</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_attention_heads: number of attention heads (n). Note that we</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">46</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_attention_heads: number of attention heads (n). Note that we</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">43</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; require n to be divisible by number of GPUs</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">47</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; require n to be divisible by number of GPUs</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">44</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; used to parallelize the model. Also, we</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">48</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; used to parallelize the model. Also, we</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">45</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; require hidden size to be divisible by n.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">49</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; require hidden size to be divisible by n.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">46</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; dropout_prob: dropout probability for the attention scores.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">50</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; dropout_prob: dropout probability for the attention scores.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">47</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; init_method: weight initialization.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">51</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; init_method: weight initialization.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">48</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_layer_init_method: output layer initialization. If None, use</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">52</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_layer_init_method: output layer initialization. If None, use</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">49</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; `init_method`.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">53</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; `init_method`.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">50</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; We use the following notation:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">54</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; We use the following notation:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">51</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; h: hidden_size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">55</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; h: hidden_size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">52</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; n: num_attention_heads</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">56</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; n: num_attention_heads</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">53</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; p: number of partitions</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">57</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; p: number of partitions</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">54</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; np: n/p</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">58</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; np: n/p</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">55</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hp: h/p</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">59</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hp: h/p</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">56</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hn: h/n</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">60</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hn: h/n</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">57</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; b: batch size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">61</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; b: batch size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">58</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; s: sequence length</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">62</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; s: sequence length</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">59</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">63</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">60</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">64</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">61</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">65</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">62</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">66</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">63</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">GPT2ParallelSelfAttention</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">67</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">GPT2ParallelSelfAttention</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">64</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set output layer initialization if not provided.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">68</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set output layer initialization if not provided.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">65</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementKeyword">is</span> <span class="TextSegElementKeyword">None</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">69</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementKeyword">is</span> <span class="TextSegElementKeyword">None</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">66</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">init_method</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">70</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">init_method</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">67</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Per attention head and per partition values.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">71</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Per attention head and per partition values.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">68</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">world_size</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_model_parallel_world_size</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">72</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">world_size</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_model_parallel_world_size</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">69</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_partition</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">world_size</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">73</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_partition</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">world_size</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">70</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">74</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">71</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">75</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">72</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads_per_partition</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">76</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads_per_partition</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">73</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">world_size</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">77</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">world_size</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">74</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Strided linear layer.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">78</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Strided linear layer.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">75</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">query_key_value</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">ColumnParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">79</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">query_key_value</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">ColumnParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">76</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">stride</span><span class="TextSegElementOperator">=</span>3<span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">80</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">stride</span><span class="TextSegElementOperator">=</span>3<span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">77</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">gather_output</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">81</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">gather_output</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">78</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">82</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">79</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Dropout. Note that for a single iteration, this layer will generate</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">83</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Dropout. Note that for a single iteration, this layer will generate</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">80</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # different outputs on different number of parallel partitions but</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">84</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # different outputs on different number of parallel partitions but</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">81</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # on average it should not be partition dependent.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">85</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # on average it should not be partition dependent.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">82</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention_dropout</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">86</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention_dropout</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">83</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">87</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">84</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Output.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">88</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Output.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">85</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">RowParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">89</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">RowParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">86</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">90</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">87</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">91</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">88</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">92</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">89</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output_dropout</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">93</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output_dropout</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">94</td>
<td class="TextItemInsigMod Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">95</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">deepspeed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpointing</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">is_configured</span><span class="TextSegSigDiff">()</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">96</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">global</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">get_cuda_rng_tracker</span><span class="TextSegSigDiff">,</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">checkpoint</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">97</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">get_cuda_rng_tracker</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">=</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">deepspeed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpointing</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_cuda_rng_tracker</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">98</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">checkpoint</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">=</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">deepspeed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpointing</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpoint</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">99</td>
<td class="TextItemInsigMod Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">90</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">100</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">91</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">101</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">92</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Transpose a 3D tensor [b, s, np*hn] into a 4D tensor with</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">102</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Transpose a 3D tensor [b, s, np*hn] into a 4D tensor with</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">93</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; size [b, np, s, hn].</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">103</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; size [b, np, s, hn].</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">94</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">104</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">95</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">new_tensor_shape</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">size</span><span class="TextSegElementOperator">()[</span>:<span class="TextSegElementOperator">-</span>1<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">+</span> \</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">105</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">new_tensor_shape</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">size</span><span class="TextSegElementOperator">()[</span>:<span class="TextSegElementOperator">-</span>1<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">+</span> \</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">96</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads_per_partition</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">106</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads_per_partition</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">97</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">107</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">98</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tensor</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">view</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">new_tensor_shape</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">108</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tensor</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">view</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">new_tensor_shape</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">99</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">permute</span><span class="TextSegElementOperator">(</span>0<span class="TextSegElementOperator">,</span> 2<span class="TextSegElementOperator">,</span> 1<span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">109</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">permute</span><span class="TextSegElementOperator">(</span>0<span class="TextSegElementOperator">,</span> 2<span class="TextSegElementOperator">,</span> 1<span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">100</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">110</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">101</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">ltor_mask</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">111</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">ltor_mask</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">102</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # hidden_states: [b, s, h]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">112</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # hidden_states: [b, s, h]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">103</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # ltor_mask: [1, 1, s, s]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">113</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # ltor_mask: [1, 1, s, s]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">104</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">114</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">105</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Attention heads. [b, s, hp]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">115</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Attention heads. [b, s, hp]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">106</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">mixed_x_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">query_key_value</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">116</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">mixed_x_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">query_key_value</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">107</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_query_layer</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">117</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_query_layer</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">108</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">mixed_key_layer</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">118</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">mixed_key_layer</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">109</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">mixed_value_layer</span><span class="TextSegElementOperator">)</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">split_tensor_along_last_dim</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_x_layer</span><span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">119</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">mixed_value_layer</span><span class="TextSegElementOperator">)</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">split_tensor_along_last_dim</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_x_layer</span><span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">110</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">120</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">111</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Reshape and transpose [b, np, s, hn]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">121</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Reshape and transpose [b, np, s, hn]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">112</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">query_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_query_layer</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">122</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">query_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_query_layer</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">113</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">key_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_key_layer</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">123</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">key_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_key_layer</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">114</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">value_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_value_layer</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">124</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">value_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_value_layer</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">115</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">125</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">116</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Raw attention scores. [b, np, s, s]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">126</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Raw attention scores. [b, np, s, s]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">117</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">matmul</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">query_layer</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">127</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">matmul</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">query_layer</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">118</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">key_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">transpose</span><span class="TextSegElementOperator">(-</span>1<span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">-</span>2<span class="TextSegElementOperator">))</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">128</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">key_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">transpose</span><span class="TextSegElementOperator">(-</span>1<span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">-</span>2<span class="TextSegElementOperator">))</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">119</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">/</span> <span class="TextSegElementIdentifier">math</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">sqrt</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">129</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">/</span> <span class="TextSegElementIdentifier">math</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">sqrt</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">120</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">130</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">121</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Apply the left to right attention mask.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">131</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Apply the left to right attention mask.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">122</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">mul</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_scores</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">ltor_mask</span><span class="TextSegElementOperator">)</span> <span class="TextSegElementOperator">-</span> \</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">132</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">mul</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_scores</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">ltor_mask</span><span class="TextSegElementOperator">)</span> <span class="TextSegElementOperator">-</span> \</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">123</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementNumber">10000.0</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementOperator">(</span><span class="TextSegElementNumber">1.0</span> <span class="TextSegElementOperator">-</span> <span class="TextSegElementIdentifier">ltor_mask</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">133</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementNumber">10000.0</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementOperator">(</span><span class="TextSegElementNumber">1.0</span> <span class="TextSegElementOperator">-</span> <span class="TextSegElementIdentifier">ltor_mask</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">124</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">134</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">125</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Attention probabilities. [b, np, s, s]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">135</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Attention probabilities. [b, np, s, s]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">126</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_probs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Softmax</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">dim</span><span class="TextSegElementOperator">=-</span>1<span class="TextSegElementOperator">)(</span><span class="TextSegElementIdentifier">attention_scores</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">136</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_probs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Softmax</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">dim</span><span class="TextSegElementOperator">=-</span>1<span class="TextSegElementOperator">)(</span><span class="TextSegElementIdentifier">attention_scores</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">127</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # This is actually dropping out entire tokens to attend to, which might</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">137</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # This is actually dropping out entire tokens to attend to, which might</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">128</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # seem a bit unusual, but is taken from the original Transformer paper.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">138</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # seem a bit unusual, but is taken from the original Transformer paper.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">129</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">fork</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">139</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">fork</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">130</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_probs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention_dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_probs</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">140</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_probs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention_dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_probs</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">131</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">141</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">132</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Context layer.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">142</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Context layer.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">133</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, np, s, hn]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">143</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, np, s, hn]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">134</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">matmul</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_probs</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">value_layer</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">144</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">matmul</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_probs</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">value_layer</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">135</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, np, hn]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">145</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, np, hn]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">136</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">permute</span><span class="TextSegElementOperator">(</span>0<span class="TextSegElementOperator">,</span> 2<span class="TextSegElementOperator">,</span> 1<span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">contiguous</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">146</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">permute</span><span class="TextSegElementOperator">(</span>0<span class="TextSegElementOperator">,</span> 2<span class="TextSegElementOperator">,</span> 1<span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">contiguous</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">137</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">new_context_layer_shape</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">size</span><span class="TextSegElementOperator">()[</span>:<span class="TextSegElementOperator">-</span>2<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">+</span> \</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">147</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">new_context_layer_shape</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">size</span><span class="TextSegElementOperator">()[</span>:<span class="TextSegElementOperator">-</span>2<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">+</span> \</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">138</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_partition</span><span class="TextSegElementOperator">,)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">148</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_partition</span><span class="TextSegElementOperator">,)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">139</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, hp]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">149</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, hp]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">140</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">view</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">new_context_layer_shape</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">150</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">view</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">new_context_layer_shape</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">141</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">151</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">142</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Output. [b, s, h]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">152</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Output. [b, s, h]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">143</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">153</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">144</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output_dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">output</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">154</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output_dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">output</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">145</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">155</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">146</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">output</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">156</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">output</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">147</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">157</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">148</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">158</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">149</td>
<td class="TextItemSame Wrap"><span class="TextSegElementOperator">@</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">jit</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">script</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">159</td>
<td class="TextItemSame Wrap"><span class="TextSegElementOperator">@</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">jit</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">script</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">150</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">gelu_impl</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">x</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">160</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">gelu_impl</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">x</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">151</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;OpenAI's gelu implementation.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">161</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;OpenAI's gelu implementation.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">152</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementNumber">0.5</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementIdentifier">x</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementOperator">(</span><span class="TextSegElementNumber">1.0</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tanh</span><span class="TextSegElementOperator">(</span><span class="TextSegElementNumber">0.7978845608028654</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementIdentifier">x</span> <span class="TextSegElementOperator">*</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">162</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementNumber">0.5</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementIdentifier">x</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementOperator">(</span><span class="TextSegElementNumber">1.0</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">tanh</span><span class="TextSegElementOperator">(</span><span class="TextSegElementNumber">0.7978845608028654</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementIdentifier">x</span> <span class="TextSegElementOperator">*</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">153</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementNumber">1.0</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementNumber">0.044715</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementIdentifier">x</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementIdentifier">x</span><span class="TextSegElementOperator">)))</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">163</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementNumber">1.0</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementNumber">0.044715</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementIdentifier">x</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementIdentifier">x</span><span class="TextSegElementOperator">)))</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">154</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">164</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">155</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">gelu</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">x</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">165</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">gelu</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">x</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">156</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">gelu_impl</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">x</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">166</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">gelu_impl</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">x</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">157</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">167</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">158</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">168</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">159</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">GPT2ParallelMLP</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">169</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">GPT2ParallelMLP</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">160</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;MLP for GPT2.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">170</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;MLP for GPT2.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">161</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">171</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">162</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; MLP will take the input with h hidden state, project it to 4*h</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">172</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; MLP will take the input with h hidden state, project it to 4*h</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">163</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; hidden dimension, perform gelu transformation, and project the</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">173</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; hidden dimension, perform gelu transformation, and project the</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">164</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; state back into h hidden dimension. At the end, dropout is also</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">174</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; state back into h hidden dimension. At the end, dropout is also</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">165</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; applied.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">175</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; applied.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">166</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">176</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">167</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">177</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">168</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: The hidden size of the self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">178</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: The hidden size of the self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">169</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_dropout_prob: dropout probability for the outputs</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">179</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_dropout_prob: dropout probability for the outputs</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">170</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after self attention and final output.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">180</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after self attention and final output.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">171</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; init_method: initialization method used for the weights. Note</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">181</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; init_method: initialization method used for the weights. Note</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">172</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; that all biases are initialized to zero and</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">182</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; that all biases are initialized to zero and</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">173</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layernorm weight are initialized to one.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">183</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layernorm weight are initialized to one.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">174</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_layer_init_method: output layer initialization. If None,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">184</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_layer_init_method: output layer initialization. If None,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">175</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; use `init_method`.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">185</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; use `init_method`.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">176</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">186</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">177</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">187</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">178</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">188</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">179</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">189</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">180</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">GPT2ParallelMLP</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">190</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">GPT2ParallelMLP</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">181</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set output layer initialization if not provided.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">191</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set output layer initialization if not provided.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">182</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementKeyword">is</span> <span class="TextSegElementKeyword">None</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">192</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementKeyword">is</span> <span class="TextSegElementKeyword">None</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">183</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">init_method</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">193</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">init_method</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">184</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Project to 4h.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">194</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Project to 4h.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">185</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense_h_to_4h</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">ColumnParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> 4<span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">195</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense_h_to_4h</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">ColumnParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> 4<span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">186</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">gather_output</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">196</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">gather_output</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">187</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">197</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">188</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Project back to h.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">198</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Project back to h.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">189</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense_4h_to_h</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">RowParallelLinear</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">199</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense_4h_to_h</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">RowParallelLinear</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">190</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span>4<span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">200</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span>4<span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">191</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">201</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">192</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">202</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">193</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">203</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">194</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">204</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">195</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">205</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">196</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">206</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">197</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, 4hp]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">207</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, 4hp]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">198</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense_h_to_4h</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">208</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense_h_to_4h</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">199</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">gelu</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">intermediate_parallel</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">209</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">gelu</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">intermediate_parallel</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">200</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">210</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">201</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, h]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">211</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, h]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">202</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense_4h_to_h</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">intermediate_parallel</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">212</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense_4h_to_h</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">intermediate_parallel</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">203</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">output</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">213</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">output</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">204</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">output</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">214</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">output</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">205</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">215</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">206</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">216</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">207</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">GPT2ParallelTransformerLayer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">217</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">GPT2ParallelTransformerLayer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">208</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;A single layer transformer for GPT2.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">218</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;A single layer transformer for GPT2.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">209</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">219</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">210</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; We use the following notation:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">220</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; We use the following notation:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">211</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; h: hidden size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">221</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; h: hidden size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">212</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; n: number of attention heads</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">222</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; n: number of attention heads</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">213</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; b: batch size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">223</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; b: batch size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">214</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; s: sequence length</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">224</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; s: sequence length</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">215</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Transformore layer takes input with size [b, s, h] and returns an</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">225</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Transformore layer takes input with size [b, s, h] and returns an</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">216</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; output of the same size.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">226</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; output of the same size.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">217</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">227</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">218</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">228</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">219</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: The hidden size of the self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">229</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: The hidden size of the self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">220</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_attention_heads: number of attention head in the self</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">230</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_attention_heads: number of attention head in the self</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">221</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">231</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">222</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; attention_dropout_prob: dropout probability of the attention</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">232</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; attention_dropout_prob: dropout probability of the attention</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">223</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; score in self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">233</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; score in self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">224</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_dropout_prob: dropout probability for the outputs</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">234</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_dropout_prob: dropout probability for the outputs</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">225</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after self attention and final output.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">235</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after self attention and final output.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">226</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; layernorm_epsilon: epsilon used in layernorm to avoid</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">236</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; layernorm_epsilon: epsilon used in layernorm to avoid</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">227</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; division by zero.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">237</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; division by zero.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">228</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; init_method: initialization method used for the weights. Note</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">238</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; init_method: initialization method used for the weights. Note</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">229</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; that all biases are initialized to zero and</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">239</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; that all biases are initialized to zero and</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">230</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layernorm weight are initialized to one.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">240</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layernorm weight are initialized to one.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">231</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_layer_init_method: output layers (attention output and</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">241</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_layer_init_method: output layers (attention output and</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">232</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mlp output) initialization. If None,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">242</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; mlp output) initialization. If None,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">233</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; use `init_method`.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">243</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; use `init_method`.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">234</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">244</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">235</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">245</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">236</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">246</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">237</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">247</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">238</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">248</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">239</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">249</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">240</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">250</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">241</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">251</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">242</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">252</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">None</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">243</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">GPT2ParallelTransformerLayer</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">253</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">GPT2ParallelTransformerLayer</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">244</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set output layer initialization if not provided.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">254</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Set output layer initialization if not provided.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">245</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementKeyword">is</span> <span class="TextSegElementKeyword">None</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">255</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementKeyword">is</span> <span class="TextSegElementKeyword">None</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">246</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">init_method</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">256</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">init_method</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">247</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">257</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">248</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Layernorm on the input data.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">258</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Layernorm on the input data.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">249</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">input_layernorm</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">LayerNorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">eps</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">259</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">input_layernorm</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">LayerNorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">eps</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">250</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">260</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">251</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">261</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">252</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">GPT2ParallelSelfAttention</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">262</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">GPT2ParallelSelfAttention</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">253</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">263</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">254</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">264</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">255</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">265</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">256</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">266</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">257</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">267</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">258</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">268</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">259</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">269</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">260</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Layernorm on the input data.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">270</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Layernorm on the input data.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">261</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">post_attention_layernorm</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">LayerNorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">271</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">post_attention_layernorm</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">LayerNorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">262</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">eps</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">272</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">eps</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">263</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">273</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">264</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # MLP</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">274</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # MLP</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">265</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">mlp</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">GPT2ParallelMLP</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">275</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">mlp</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">GPT2ParallelMLP</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">266</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">276</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">267</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">277</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">268</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">278</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">269</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">279</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">270</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">280</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">271</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">ltor_mask</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">281</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">ltor_mask</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">272</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # hidden_states: [b, s, h]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">282</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # hidden_states: [b, s, h]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">273</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # ltor_mask: [1, 1, s, s]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">283</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # ltor_mask: [1, 1, s, s]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">274</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">284</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">275</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Layer norm at the begining of the transformer layer.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">285</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Layer norm at the begining of the transformer layer.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">276</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">input_layernorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">286</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">input_layernorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">277</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">287</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">278</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">layernorm_output</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">ltor_mask</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">288</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">layernorm_output</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">ltor_mask</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">279</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Residual connection.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">289</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Residual connection.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">280</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_input</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">attention_output</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">290</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_input</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">attention_output</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">281</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Layer norm post the self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">291</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Layer norm post the self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">282</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">post_attention_layernorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">layernorm_input</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">292</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">post_attention_layernorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">layernorm_input</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">283</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # MLP.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">293</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # MLP.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">284</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">mlp_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">mlp</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">layernorm_output</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">294</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">mlp_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">mlp</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">layernorm_output</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">285</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Second residual connection.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">295</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Second residual connection.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">286</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">layernorm_input</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">mlp_output</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">296</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">layernorm_input</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">mlp_output</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">287</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">297</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">288</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">output</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">298</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">output</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">289</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">299</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">290</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">300</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">291</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">unscaled_init_method</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">sigma</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">301</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">unscaled_init_method</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">sigma</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">292</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Init method based on N(0, sigma).&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">302</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Init method based on N(0, sigma).&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">293</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">init_</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">303</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">init_</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">294</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">init</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">normal_</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">mean</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">0.0</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">std</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">sigma</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">304</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">init</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">normal_</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">mean</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">0.0</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">std</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">sigma</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">295</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">305</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">296</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">init_</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">306</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">init_</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">297</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">307</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">298</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">308</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">299</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">scaled_init_method</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">sigma</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">309</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">scaled_init_method</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">sigma</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">300</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Init method based on N(0, sigma/sqrt(2*num_layers).&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">310</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Init method based on N(0, sigma/sqrt(2*num_layers).&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">301</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">std</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">sigma</span> <span class="TextSegElementOperator">/</span> <span class="TextSegElementIdentifier">math</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">sqrt</span><span class="TextSegElementOperator">(</span><span class="TextSegElementNumber">2.0</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">311</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementIdentifier">std</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">sigma</span> <span class="TextSegElementOperator">/</span> <span class="TextSegElementIdentifier">math</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">sqrt</span><span class="TextSegElementOperator">(</span><span class="TextSegElementNumber">2.0</span> <span class="TextSegElementOperator">*</span> <span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">302</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">init_</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">312</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">init_</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">303</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">init</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">normal_</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">mean</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">0.0</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">std</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">std</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">313</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">init</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">normal_</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">mean</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">0.0</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">std</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">std</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">304</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">314</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">305</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">init_</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">315</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">init_</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">306</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">316</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">307</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">317</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">308</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">GPT2ParallelTransformer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">318</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">GPT2ParallelTransformer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">309</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;GPT-2 transformer.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">319</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;GPT-2 transformer.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">310</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">320</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">311</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; This module takes input from embedding layer and it's output can</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">321</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; This module takes input from embedding layer and it's output can</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">312</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; be used directly by a logit layer. It consists of L (num-layers)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">322</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; be used directly by a logit layer. It consists of L (num-layers)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">313</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; blocks of:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">323</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; blocks of:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">314</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; layer norm</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">324</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; layer norm</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">315</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; self attention</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">325</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; self attention</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">316</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; residual connection</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">326</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; residual connection</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">317</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; layer norm</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">327</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; layer norm</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">318</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; mlp</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">328</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; mlp</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">319</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; residual connection</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">329</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; residual connection</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">320</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; followed by a final layer norm.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">330</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; followed by a final layer norm.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">321</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">331</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">322</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">332</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">323</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_layers: Number of transformer layers.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">333</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_layers: Number of transformer layers.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">324</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: The hidden size of the self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">334</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: The hidden size of the self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">325</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_attention_heads: number of attention head in the self</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">335</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_attention_heads: number of attention head in the self</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">326</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">336</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">327</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; attention_dropout_prob: dropout probability of the attention</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">337</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; attention_dropout_prob: dropout probability of the attention</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">328</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; score in self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">338</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; score in self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">329</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_dropout_prob: dropout probability for the outputs</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">339</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_dropout_prob: dropout probability for the outputs</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">330</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after self attention and final output.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">340</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after self attention and final output.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">331</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; checkpoint_activations: if True, checkpoint activations.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">341</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; checkpoint_activations: if True, checkpoint activations.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">332</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; checkpoint_num_layers: number of layers to checkpoint. This</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">342</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; checkpoint_num_layers: number of layers to checkpoint. This</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">333</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is basically the chunk size in checkpoitning.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">343</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is basically the chunk size in checkpoitning.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">334</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; layernorm_epsilon: epsilon used in layernorm to avoid</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">344</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; layernorm_epsilon: epsilon used in layernorm to avoid</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">335</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; division by zero.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">345</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; division by zero.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">336</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; init_method_std: standard deviation of the init method which has</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">346</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; init_method_std: standard deviation of the init method which has</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">337</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the form N(0, std).</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">347</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the form N(0, std).</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">338</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; use_scaled_init_for_output_weights: If Ture use 1/sqrt(2*num_layers)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">348</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; use_scaled_init_for_output_weights: If Ture use 1/sqrt(2*num_layers)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">339</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; scaling for the output weights (</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">349</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; scaling for the output weights (</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">340</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; output of self attention and mlp).</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">350</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; output of self attention and mlp).</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">341</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">351</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">342</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">352</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">343</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">353</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">344</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">354</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">345</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">355</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">346</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">356</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">347</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">357</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">348</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">checkpoint_activations</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">358</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">checkpoint_activations</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">349</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">checkpoint_num_layers</span><span class="TextSegElementOperator">=</span>1<span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">359</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">checkpoint_num_layers</span><span class="TextSegElementOperator">=</span>1<span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">350</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">1.0</span><span class="TextSegElementIdentifier">e</span><span class="TextSegElementOperator">-</span>5<span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">360</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">1.0</span><span class="TextSegElementIdentifier">e</span><span class="TextSegElementOperator">-</span>5<span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">351</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method_std</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">0.02</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">361</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method_std</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">0.02</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">352</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">use_scaled_init_for_output_weights</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">362</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">use_scaled_init_for_output_weights</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">353</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">GPT2ParallelTransformer</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">363</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">GPT2ParallelTransformer</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">354</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Store activation checkpoiting flag.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">364</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Store activation checkpoiting flag.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">355</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_activations</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">checkpoint_activations</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">365</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_activations</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">checkpoint_activations</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">356</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_num_layers</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">checkpoint_num_layers</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">366</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_num_layers</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">checkpoint_num_layers</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">357</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">367</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">358</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementKeyword">None</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">368</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementKeyword">None</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">359</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">use_scaled_init_for_output_weights</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">369</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">use_scaled_init_for_output_weights</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">360</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">scaled_init_method</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">init_method_std</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">370</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">scaled_init_method</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">init_method_std</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">361</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">371</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">362</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">get_layer</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">372</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">get_layer</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">363</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">GPT2ParallelTransformerLayer</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">373</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">GPT2ParallelTransformerLayer</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">364</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">374</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">365</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">375</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">366</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">376</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">367</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">377</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">368</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">378</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">369</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">unscaled_init_method</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">init_method_std</span><span class="TextSegElementOperator">),</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">379</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">unscaled_init_method</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">init_method_std</span><span class="TextSegElementOperator">),</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">370</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">380</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">output_layer_init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">371</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">381</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">372</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Transformer layers.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">382</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Transformer layers.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">373</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">ModuleList</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">383</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">ModuleList</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">374</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">get_layer</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">_</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">range</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">)])</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">384</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">get_layer</span><span class="TextSegElementOperator">()</span> <span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">_</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">range</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">num_layers</span><span class="TextSegElementOperator">)])</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">375</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">385</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">376</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Final layer norm before output.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">386</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Final layer norm before output.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">377</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">final_layernorm</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">LayerNorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">eps</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">387</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">final_layernorm</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">LayerNorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">eps</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">378</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">388</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">389</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">deepspeed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpointing</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">is_configured</span><span class="TextSegSigDiff">()</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">390</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">global</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">get_cuda_rng_tracker</span><span class="TextSegSigDiff">,</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">checkpoint</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">391</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">get_cuda_rng_tracker</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">=</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">deepspeed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpointing</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_cuda_rng_tracker</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">392</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">checkpoint</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">=</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">deepspeed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpointing</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpoint</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">393</td>
<td class="TextItemInsigMod Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">394</td>
<td class="TextItemInsigMod Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">379</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">395</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">380</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">396</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">381</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">custom</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">start</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">end</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">397</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">custom</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">start</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">end</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">382</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">custom_forward</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">inputs</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">398</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">custom_forward</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">inputs</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">383</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layers_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">start</span>:<span class="TextSegElementIdentifier">end</span><span class="TextSegElementOperator">]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">399</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layers_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span><span class="TextSegElementOperator">[</span><span class="TextSegElementIdentifier">start</span>:<span class="TextSegElementIdentifier">end</span><span class="TextSegElementOperator">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">384</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">x_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">inputs</span><span class="TextSegElementOperator">[</span>0<span class="TextSegElementOperator">]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">400</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">x_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">inputs</span><span class="TextSegElementOperator">[</span>0<span class="TextSegElementOperator">]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">385</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">layer</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">layers_</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">401</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">layer</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">layers_</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">386</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">x_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">layer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">x_</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">inputs</span><span class="TextSegElementOperator">[</span>1<span class="TextSegElementOperator">])</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">402</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">x_</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">layer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">x_</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">inputs</span><span class="TextSegElementOperator">[</span>1<span class="TextSegElementOperator">])</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">387</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">x_</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">403</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">x_</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">388</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">custom_forward</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">404</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">custom_forward</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">389</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">405</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">390</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_activations</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">406</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_activations</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">391</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">l</span> <span class="TextSegElementOperator">=</span> 0</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">407</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">l</span> <span class="TextSegElementOperator">=</span> 0</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">392</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">num_layers</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">len</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">408</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">num_layers</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">len</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">393</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">chunk_length</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_num_layers</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">409</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">chunk_length</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">checkpoint_num_layers</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">394</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">while</span> <span class="TextSegElementIdentifier">l</span> <span class="TextSegElementOperator">&lt;</span> <span class="TextSegElementIdentifier">num_layers</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">410</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">while</span> <span class="TextSegElementIdentifier">l</span> <span class="TextSegElementOperator">&lt;</span> <span class="TextSegElementIdentifier">num_layers</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">395</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">checkpoint</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">custom</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">l</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">l</span><span class="TextSegElementOperator">+</span><span class="TextSegElementIdentifier">chunk_length</span><span class="TextSegElementOperator">),</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">411</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">checkpoint</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">custom</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">l</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">l</span><span class="TextSegElementOperator">+</span><span class="TextSegElementIdentifier">chunk_length</span><span class="TextSegElementOperator">),</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">396</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">412</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">397</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">l</span> <span class="TextSegElementOperator">+=</span> <span class="TextSegElementIdentifier">chunk_length</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">413</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">l</span> <span class="TextSegElementOperator">+=</span> <span class="TextSegElementIdentifier">chunk_length</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">398</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">else</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">414</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">else</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">399</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">layer</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">415</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">for</span> <span class="TextSegElementIdentifier">layer</span> <span class="TextSegElementKeyword">in</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layers</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">400</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">layer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">416</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">layer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">401</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">417</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">402</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Final layer norm.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">418</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Final layer norm.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">403</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">final_layernorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">419</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">final_layernorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">404</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">420</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">405</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">output</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">421</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">output</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">406</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">422</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">407</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">423</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">408</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">BertParallelSelfAttention</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">424</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">BertParallelSelfAttention</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">409</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Parallel self-attention layer for BERT.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">425</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Parallel self-attention layer for BERT.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">410</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">426</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">411</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Self-attention layer takes input with size [b, s, h] where b is</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">427</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Self-attention layer takes input with size [b, s, h] where b is</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">412</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; the batch size, s is the sequence lenght, and h is the hidden size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">428</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; the batch size, s is the sequence lenght, and h is the hidden size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">413</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; and creates output of the same size.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">429</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; and creates output of the same size.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">414</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">430</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">415</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: total hidden size of the layer (h).</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">431</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: total hidden size of the layer (h).</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">416</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_attention_heads: number of attention heads (n). Note that we</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">432</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_attention_heads: number of attention heads (n). Note that we</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">417</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; require n to be divisible by number of GPUs</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">433</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; require n to be divisible by number of GPUs</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">418</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; used to parallelize the model. Also, we</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">434</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; used to parallelize the model. Also, we</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">419</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; require hidden size be divisible by n.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">435</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; require hidden size be divisible by n.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">420</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; dropout_prob: dropout probability for the attention scores.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">436</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; dropout_prob: dropout probability for the attention scores.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">421</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_parallel: If true, no all-gather is done on the output and</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">437</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_parallel: If true, no all-gather is done on the output and</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">422</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the output values will be per partition.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">438</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the output values will be per partition.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">423</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; We use the following notation:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">439</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; We use the following notation:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">424</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; h: hidden_size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">440</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; h: hidden_size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">425</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; n: num_attention_heads</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">441</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; n: num_attention_heads</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">426</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; p: number of partitions</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">442</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; p: number of partitions</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">427</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; np: n/p</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">443</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; np: n/p</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">428</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hp: h/p</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">444</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hp: h/p</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">429</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hn: h/n</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">445</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hn: h/n</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">430</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; b: batch size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">446</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; b: batch size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">431</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; s: sequence length</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">447</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; s: sequence length</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">432</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">448</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">433</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">449</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">434</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">dropout_prob</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">450</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">dropout_prob</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">435</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">xavier_normal_</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">451</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">xavier_normal_</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">436</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">BertParallelSelfAttention</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">452</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">BertParallelSelfAttention</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">437</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Input configuration.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">453</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Input configuration.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">438</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">hidden_size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">454</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">hidden_size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">439</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">num_attention_heads</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">455</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">num_attention_heads</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">440</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout_prob</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">dropout_prob</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">456</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout_prob</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">dropout_prob</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">441</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">output_parallel</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">457</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">output_parallel</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">442</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Per attention head and per partition values.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">458</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Per attention head and per partition values.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">443</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">world_size</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_model_parallel_world_size</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">459</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">world_size</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">get_model_parallel_world_size</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">444</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_partition</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">world_size</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">460</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_partition</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">world_size</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">445</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">461</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">446</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">462</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">447</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads_per_partition</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">463</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads_per_partition</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">divide</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">448</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">world_size</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">464</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">world_size</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">449</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Strided linear layer.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">465</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Strided linear layer.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">450</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">query_key_value</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">ColumnParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">466</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">query_key_value</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">ColumnParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">*</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">451</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">stride</span><span class="TextSegElementOperator">=</span>3<span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">467</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">stride</span><span class="TextSegElementOperator">=</span>3<span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">452</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">gather_output</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">468</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">gather_output</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">453</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">469</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">454</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Dropout. Note that for a single iteration, this layer will generate</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">470</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Dropout. Note that for a single iteration, this layer will generate</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">455</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # different outputs on different number of parallel partitions but</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">471</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # different outputs on different number of parallel partitions but</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">456</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # on average it should not be partition dependent.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">472</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # on average it should not be partition dependent.</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">457</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">dropout_prob</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">473</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">dropout_prob</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">-+</td>
<td class="TextItemNum AlignRight Wrap">474</td>
<td class="TextItemInsigMod Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">475</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">if</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">deepspeed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpointing</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">is_configured</span><span class="TextSegSigDiff">()</span><span class="TextSegSigDiff">:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">476</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">global</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">get_cuda_rng_tracker</span><span class="TextSegSigDiff">,</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">checkpoint</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">477</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">get_cuda_rng_tracker</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">=</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">deepspeed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpointing</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">get_cuda_rng_tracker</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">478</td>
<td class="TextItemSigMod Wrap"><span class="TextSegSigDiff">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegSigDiff">checkpoint</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">=</span><span class="TextSegInsigDiff"> </span><span class="TextSegSigDiff">deepspeed</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpointing</span><span class="TextSegSigDiff">.</span><span class="TextSegSigDiff">checkpoint</span></td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">&nbsp;</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">479</td>
<td class="TextItemInsigMod Wrap">&nbsp;</td>
</tr>
<tr class="SectionBegin">
<td class="TextItemNum AlignRight Wrap">458</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">=</td>
<td class="TextItemNum AlignRight Wrap">480</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">459</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">481</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">460</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Transpose a 3D tensor [b, s, np*hn] into a 4D tensor with</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">482</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;Transpose a 3D tensor [b, s, np*hn] into a 4D tensor with</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">461</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; size [b, np, s, hn].</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">483</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; size [b, np, s, hn].</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">462</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">484</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">463</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">new_tensor_shape</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">size</span><span class="TextSegElementOperator">()[</span>:<span class="TextSegElementOperator">-</span>1<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">+</span> \</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">485</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">new_tensor_shape</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">size</span><span class="TextSegElementOperator">()[</span>:<span class="TextSegElementOperator">-</span>1<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">+</span> \</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">464</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads_per_partition</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">486</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">num_attention_heads_per_partition</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">465</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">487</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">466</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tensor</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">view</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">new_tensor_shape</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">488</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">tensor</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">view</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">new_tensor_shape</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">467</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">permute</span><span class="TextSegElementOperator">(</span>0<span class="TextSegElementOperator">,</span> 2<span class="TextSegElementOperator">,</span> 1<span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">489</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">tensor</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">permute</span><span class="TextSegElementOperator">(</span>0<span class="TextSegElementOperator">,</span> 2<span class="TextSegElementOperator">,</span> 1<span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">468</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">490</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">469</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">491</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">470</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">492</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">471</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Attention heads. [b, s, hp]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">493</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Attention heads. [b, s, hp]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">472</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">mixed_x_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">query_key_value</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">494</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">mixed_x_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">query_key_value</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">473</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_query_layer</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">495</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_query_layer</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">474</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">mixed_key_layer</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">496</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">mixed_key_layer</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">475</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">mixed_value_layer</span><span class="TextSegElementOperator">)</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">split_tensor_along_last_dim</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_x_layer</span><span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">497</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">mixed_value_layer</span><span class="TextSegElementOperator">)</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">split_tensor_along_last_dim</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_x_layer</span><span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">476</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">498</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">477</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Reshape and transpose [b, np, s, hn]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">499</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Reshape and transpose [b, np, s, hn]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">478</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">query_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_query_layer</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">500</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">query_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_query_layer</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">479</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">key_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_key_layer</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">501</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">key_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_key_layer</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">480</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">value_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_value_layer</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">502</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">value_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">_transpose_for_scores</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">mixed_value_layer</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">481</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">503</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">482</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Raw attention scores. [b, np, s, s]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">504</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Raw attention scores. [b, np, s, s]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">483</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">norm_factor</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">math</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">sqrt</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">math</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">sqrt</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span><span class="TextSegElementOperator">))</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">505</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">norm_factor</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">math</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">sqrt</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">math</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">sqrt</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_attention_head</span><span class="TextSegElementOperator">))</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">484</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">matmul</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">query_layer</span><span class="TextSegElementOperator">/</span><span class="TextSegElementIdentifier">norm_factor</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">506</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">matmul</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">query_layer</span><span class="TextSegElementOperator">/</span><span class="TextSegElementIdentifier">norm_factor</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">485</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">key_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">transpose</span><span class="TextSegElementOperator">(-</span>1<span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">-</span>2<span class="TextSegElementOperator">)/</span><span class="TextSegElementIdentifier">norm_factor</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">507</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">key_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">transpose</span><span class="TextSegElementOperator">(-</span>1<span class="TextSegElementOperator">,</span> <span class="TextSegElementOperator">-</span>2<span class="TextSegElementOperator">)/</span><span class="TextSegElementIdentifier">norm_factor</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">486</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Apply the attention mask.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">508</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Apply the attention mask.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">487</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">+=</span> <span class="TextSegElementIdentifier">attention_mask</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">509</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_scores</span> <span class="TextSegElementOperator">+=</span> <span class="TextSegElementIdentifier">attention_mask</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">488</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">510</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">489</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Attention probabilities. [b, np, s, s]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">511</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Attention probabilities. [b, np, s, s]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">490</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_probs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Softmax</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">dim</span><span class="TextSegElementOperator">=-</span>1<span class="TextSegElementOperator">)(</span><span class="TextSegElementIdentifier">attention_scores</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">512</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_probs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Softmax</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">dim</span><span class="TextSegElementOperator">=-</span>1<span class="TextSegElementOperator">)(</span><span class="TextSegElementIdentifier">attention_scores</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">491</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # This is actually dropping out entire tokens to attend to, which might</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">513</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # This is actually dropping out entire tokens to attend to, which might</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">492</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # seem a bit unusual, but is taken from the original Transformer paper.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">514</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # seem a bit unusual, but is taken from the original Transformer paper.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">493</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">fork</span><span class="TextSegElementOperator">()</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">515</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">with</span> <span class="TextSegElementIdentifier">get_cuda_rng_tracker</span><span class="TextSegElementOperator">().</span><span class="TextSegElementIdentifier">fork</span><span class="TextSegElementOperator">()</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">494</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_probs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_probs</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">516</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_probs</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_probs</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">495</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">517</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">496</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Context layer.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">518</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Context layer.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">497</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, np, s, hn]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">519</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, np, s, hn]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">498</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">matmul</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_probs</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">value_layer</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">520</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">matmul</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_probs</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">value_layer</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">499</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, np, hn]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">521</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, np, hn]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">500</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">permute</span><span class="TextSegElementOperator">(</span>0<span class="TextSegElementOperator">,</span> 2<span class="TextSegElementOperator">,</span> 1<span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">contiguous</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">522</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">permute</span><span class="TextSegElementOperator">(</span>0<span class="TextSegElementOperator">,</span> 2<span class="TextSegElementOperator">,</span> 1<span class="TextSegElementOperator">,</span> 3<span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">contiguous</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">501</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">new_context_layer_shape</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">size</span><span class="TextSegElementOperator">()[</span>:<span class="TextSegElementOperator">-</span>2<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">+</span> \</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">523</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">new_context_layer_shape</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">size</span><span class="TextSegElementOperator">()[</span>:<span class="TextSegElementOperator">-</span>2<span class="TextSegElementOperator">]</span> <span class="TextSegElementOperator">+</span> \</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">502</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_partition</span><span class="TextSegElementOperator">,)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">524</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">hidden_size_per_partition</span><span class="TextSegElementOperator">,)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">503</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, hp]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">525</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, hp]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">504</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">view</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">new_context_layer_shape</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">526</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">context_layer</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">view</span><span class="TextSegElementOperator">(*</span><span class="TextSegElementIdentifier">new_context_layer_shape</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">505</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">527</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">506</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Output. [b, s, h]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">528</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Output. [b, s, h]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">507</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output_parallel</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">529</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">if</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output_parallel</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">508</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">530</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">context_layer</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">509</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">else</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">531</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">else</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">510</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">gather_from_model_parallel_region</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">532</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">gather_from_model_parallel_region</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">context_layer</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">511</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">533</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">512</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">output</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">534</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">output</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">513</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">535</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">514</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">536</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">515</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">BertParallelTransformerOutput</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">537</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">BertParallelTransformerOutput</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">516</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;The output layer used after self attention and intermediate</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">538</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;The output layer used after self attention and intermediate</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">517</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; parts of transformer layer.&quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">539</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; parts of transformer layer.&quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">518</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">input_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">540</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">input_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">519</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">1.0</span><span class="TextSegElementIdentifier">e</span><span class="TextSegElementOperator">-</span>12<span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">541</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">=</span><span class="TextSegElementNumber">1.0</span><span class="TextSegElementIdentifier">e</span><span class="TextSegElementOperator">-</span>12<span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">520</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">xavier_normal_</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">542</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">xavier_normal_</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">521</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">BertParallelTransformerOutput</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">543</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">BertParallelTransformerOutput</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">522</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Components.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">544</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Components.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">523</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">RowParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">input_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">545</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">RowParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">input_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">524</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">546</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">525</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">547</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">526</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">548</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">527</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">dropout_prob</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">549</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">dropout_prob</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">528</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layernorm</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">LayerNorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">output_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">eps</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">550</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layernorm</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">LayerNorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">output_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">eps</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">529</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">551</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">530</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">input_tensor</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">552</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">input_tensor</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">531</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">553</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dense</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">532</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">554</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">dropout</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">533</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_input</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">input_tensor</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">555</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_input</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">+</span> <span class="TextSegElementIdentifier">input_tensor</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">534</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layernorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">layernorm_input</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">556</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">layernorm</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">layernorm_input</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">535</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">hidden_states</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">557</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">hidden_states</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">536</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">558</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">537</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">559</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">538</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">BertParallelTransformerLayer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">560</td>
<td class="TextItemSame Wrap"><span class="TextSegElementKeyword">class</span> <span class="TextSegElementIdentifier">BertParallelTransformerLayer</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">torch</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">nn</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">Module</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">539</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;A single layer transformer for Bert.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">561</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementString">&quot;&quot;&quot;A single layer transformer for Bert.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">540</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">562</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">541</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; We use the following notation:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">563</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; We use the following notation:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">542</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; h: hidden size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">564</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; h: hidden size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">543</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; n: number of attention heads</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">565</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; n: number of attention heads</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">544</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; b: batch size</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">566</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; b: batch size</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">545</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; s: sequence length</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">567</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; s: sequence length</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">546</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Transformore layer takes input with size [b, s, h] and returns an</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">568</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Transformore layer takes input with size [b, s, h] and returns an</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">547</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; output of the same size.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">569</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; output of the same size.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">548</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">570</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">549</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">571</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; Arguments:</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">550</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: The hidden size of the self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">572</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; hidden_size: The hidden size of the self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">551</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; intermediate_size: size of the intermediate state after</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">573</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; intermediate_size: size of the intermediate state after</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">552</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self attention. In both BERT and GPT</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">574</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self attention. In both BERT and GPT</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">553</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this is set to be 4 times the hidden</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">575</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this is set to be 4 times the hidden</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">554</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">576</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">555</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_attention_heads: number of attention head in the self</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">577</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; num_attention_heads: number of attention head in the self</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">556</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">578</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">557</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; attention_dropout_prob: dropout probability of the attention</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">579</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; attention_dropout_prob: dropout probability of the attention</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">558</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; score in self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">580</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; score in self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">559</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_dropout_prob: dropout probability for the outputs</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">581</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; output_dropout_prob: dropout probability for the outputs</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">560</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after self attention and final output.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">582</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after self attention and final output.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">561</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; intermediate_activation_fn: activation function for output</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">583</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; intermediate_activation_fn: activation function for output</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">562</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; of intermediate.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">584</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; of intermediate.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">563</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; layernorm_epsilon: epsilon used in layernorm to avoid</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">585</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; layernorm_epsilon: epsilon used in layernorm to avoid</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">564</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; division by zero.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">586</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; division by zero.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">565</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; init_method: initialization method used for the weights. Note</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">587</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; init_method: initialization method used for the weights. Note</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">566</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; that all biases are initialized to zero and</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">588</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; that all biases are initialized to zero and</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">567</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layernorm weight are initialized to one.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">589</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; layernorm weight are initialized to one.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">568</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">590</td>
<td class="TextItemSame Wrap"><span class="TextSegElementString">&nbsp;&nbsp;&nbsp; &quot;&quot;&quot;</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">569</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">591</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">570</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">592</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">571</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">intermediate_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">593</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">intermediate_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">572</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">594</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">573</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">595</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">574</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">596</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">575</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">intermediate_activation_fn</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">597</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">intermediate_activation_fn</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">576</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">598</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">577</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">xavier_normal_</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">599</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">xavier_normal_</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">578</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">BertParallelTransformerLayer</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">600</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">super</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">BertParallelTransformerLayer</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">).</span><span class="TextSegElementIdentifier">__init__</span><span class="TextSegElementOperator">()</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">579</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">601</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">580</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Self attention.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">602</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Self attention.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">581</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">BertParallelSelfAttention</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">603</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">BertParallelSelfAttention</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">582</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">604</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">num_attention_heads</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">583</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">605</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">584</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">606</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">output_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">585</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">607</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">586</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Self attention output.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">608</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Self attention output.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">587</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">self_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">BertParallelTransformerOutput</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">609</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">self_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">BertParallelTransformerOutput</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">588</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">610</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">589</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">611</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">590</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">612</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">591</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">613</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">592</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Intermediate.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">614</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Intermediate.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">593</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">intermediate</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">ColumnParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">intermediate_size</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">615</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">intermediate</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">ColumnParallelLinear</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">intermediate_size</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">594</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">gather_output</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">616</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">gather_output</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">False</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">595</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">617</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">596</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">intermediate_activation_fn</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">intermediate_activation_fn</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">618</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">intermediate_activation_fn</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">intermediate_activation_fn</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">597</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Output.</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">619</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # Output.</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">598</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">BertParallelTransformerOutput</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">620</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">BertParallelTransformerOutput</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">599</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">621</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_size</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">output_dropout_prob</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">600</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">622</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">layernorm_epsilon</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">601</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">623</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">input_is_parallel</span><span class="TextSegElementOperator">=</span><span class="TextSegElementKeyword">True</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">602</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">624</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">=</span><span class="TextSegElementIdentifier">init_method</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">603</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">625</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">604</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span>:</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">626</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp;&nbsp; </span><span class="TextSegElementKeyword">def</span> <span class="TextSegElementIdentifier">forward</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span> <span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span>:</td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">605</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, hp]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">627</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, hp]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">606</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_output_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">628</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_output_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">attention</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">607</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">629</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_mask</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">608</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, h]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">630</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, h]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">609</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_self_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">self_output</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_output_parallel</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">631</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">attention_self_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">self_output</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_output_parallel</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">610</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">632</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">hidden_states</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">611</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, ip]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">633</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, ip]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">612</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_output_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">intermediate</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_self_output</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">634</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_output_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">intermediate</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">attention_self_output</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">613</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_output_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">intermediate_activation_fn</span><span class="TextSegElementOperator">(</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">635</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_output_parallel</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">intermediate_activation_fn</span><span class="TextSegElementOperator">(</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">614</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_output_parallel</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">636</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">intermediate_output_parallel</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">615</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, h]</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">637</td>
<td class="TextItemSame Wrap"><span class="TextSegElementComment">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; # [b, s, h]</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">616</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layer_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">intermediate_output_parallel</span><span class="TextSegElementOperator">,</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">638</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementIdentifier">layer_output</span> <span class="TextSegElementOperator">=</span> <span class="TextSegElementIdentifier">self</span><span class="TextSegElementOperator">.</span><span class="TextSegElementIdentifier">output</span><span class="TextSegElementOperator">(</span><span class="TextSegElementIdentifier">intermediate_output_parallel</span><span class="TextSegElementOperator">,</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">617</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_self_output</span><span class="TextSegElementOperator">)</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">639</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="TextSegElementIdentifier">attention_self_output</span><span class="TextSegElementOperator">)</span></td>
</tr>
<tr class="SectionMiddle">
<td class="TextItemNum AlignRight Wrap">618</td>
<td class="TextItemSame Wrap">&nbsp;</td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">640</td>
<td class="TextItemSame Wrap">&nbsp;</td>
</tr>
<tr class="SectionEnd">
<td class="TextItemNum AlignRight Wrap">619</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">layer_output</span></td>
<td class="AlignCenter Wrap">&nbsp;</td>
<td class="TextItemNum AlignRight Wrap">641</td>
<td class="TextItemSame Wrap"><span class="TextSegElementIndentation">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="TextSegElementKeyword">return</span> <span class="TextSegElementIdentifier">layer_output</span></td>
</tr>
</table>
<br>
</body>
</html>
